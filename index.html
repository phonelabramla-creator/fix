<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>×˜×•×¤×¡ ×ª×™×§×•×Ÿ - Mfix</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  
  <!-- ×¡×’× ×•× ×•×ª ×”×©×™×¤×•×¨×™× -->
  <style>
    /* ×¡×’× ×•× ×•×ª ×”×©×™×¤×•×¨×™× ×”××ª×§×“××™× */
    .progress-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.7);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 10000;
      flex-direction: column;
    }
    
    .progress-container {
      background: white;
      padding: 20px;
      border-radius: 12px;
      min-width: 300px;
      text-align: center;
    }
    
    .progress-bar {
      width: 100%;
      height: 6px;
      background: #e0e0e0;
      border-radius: 3px;
      margin: 10px 0;
      overflow: hidden;
    }
    
    .progress-fill {
      height: 100%;
      background: linear-gradient(90deg, #3498db, #2ecc71);
      transition: width 0.3s ease;
    }
    
    .touch-optimized {
      min-height: 44px;
      padding: 12px 16px;
    }
    
    .offline-banner {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      background: #f39c12;
      color: white;
      text-align: center;
      padding: 10px;
      z-index: 10001;
      font-weight: bold;
    }
    
    .advanced-search-panel {
      background: #f8f9fa;
      border-radius: 8px;
      padding: 15px;
      margin: 15px 0;
      border: 1px solid #e9ecef;
    }
    
    .filter-group {
      margin-bottom: 15px;
    }
    
    .filter-group label {
      display: block;
      margin-bottom: 5px;
      font-weight: bold;
      color: #2c3e50;
    }
    
    .fade-in {
      animation: fadeIn 0.3s ease-in;
    }
    
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    .loading {
      opacity: 0.6;
      pointer-events: none;
      position: relative;
    }
    
    .loading::after {
      content: '';
      position: absolute;
      top: 50%;
      left: 50%;
      width: 20px;
      height: 20px;
      margin: -10px 0 0 -10px;
      border: 2px solid #f3f3f3;
      border-top: 2px solid #3498db;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }
    
    .notification.enhanced {
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
      border-left: 4px solid;
    }
    
    .notification.success.enhanced {
      border-left-color: #27ae60;
    }
    
    .notification.error.enhanced {
      border-left-color: #e74c3c;
    }
    
    .notification.info.enhanced {
      border-left-color: #3498db;
    }
    
    /* ×¡×’× ×•× ×•×ª ××§×•×¨×™×™× ×©×œ×š × ×©××¨×™× ×›××Ÿ */
    :root {
      --primary-color: #2c3e50;
      --secondary-color: #3498db;
      --success-color: #27ae60;
      --danger-color: #e74c3c;
      --warning-color: #f39c12;
      --light-color: #f8f9fa;
      --dark-color: #343a40;
      --border-radius: 12px;
      --box-shadow: 0 6px 20px rgba(0,0,0,0.08);
      --transition: all 0.3s ease;
    }

    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #f5f7fa 0%, #e4edf9 100%);
      padding: 20px;
      margin: 0;
      position: relative;
      line-height: 1.6;
    }
    
    .refresh-btn {
      position: absolute;
      top: 20px;
      left: 20px;
      background: #f1f5f9;
      border: 1px solid #cbd5e1;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      box-shadow: 0 2px 6px rgba(0,0,0,0.1);
      z-index: 100;
      transition: var(--transition);
    }
    .refresh-btn:hover {
      background: #e2e8f0;
      transform: rotate(20deg);
    }
    .refresh-btn i {
      color: #4a5568;
      font-size: 18px;
    }

    .container {
      max-width: 800px;
      margin: 0 auto;
      background: white;
      border-radius: var(--border-radius);
      box-shadow: var(--box-shadow);
      overflow: hidden;
      position: relative;
      padding-top: 20px;
    }
    .main-title {
      text-align: center;
      color: var(--primary-color);
      margin: 0 0 8px;
      font-size: 28px;
      font-weight: bold;
    }
    .sub-title {
      text-align: center;
      color: #7f8c8d;
      margin-bottom: 20px;
      font-size: 16px;
    }

    .tabs {
      display: flex;
      background: #f1f5f9;
      border-bottom: 1px solid #e2e8f0;
    }
    .tab-btn {
      flex: 1;
      padding: 14px;
      background: none;
      border: none;
      font-size: 16px;
      font-weight: bold;
      color: #64748b;
      cursor: pointer;
      transition: var(--transition);
    }
    .tab-btn.active {
      color: var(--secondary-color);
      background: white;
      border-bottom: 3px solid var(--secondary-color);
    }
    .tab-content {
      display: none;
      padding: 25px;
    }
    .tab-content.active {
      display: block;
    }

    .form-group, .search-group {
      margin-bottom: 20px;
    }
    label {
      display: flex;
      align-items: center;
      gap: 10px;
      font-weight: bold;
      color: var(--primary-color);
      margin-bottom: 6px;
      font-size: 15px;
    }
    label i {
      width: 24px;
      text-align: center;
      color: var(--secondary-color);
    }
    input, textarea, select {
      width: 100%;
      padding: 12px;
      border: 2px solid #e1e8f0;
      border-radius: 10px;
      box-sizing: border-box;
      font-size: 15px;
      font-family: inherit;
      transition: var(--transition);
    }
    input:focus, textarea:focus, select:focus {
      outline: none;
      border-color: var(--secondary-color);
      box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.2);
    }
    .amounts {
      display: flex;
      gap: 12px;
      margin-top: 12px;
    }
    .amount-box {
      flex: 1;
      padding: 14px;
      background: #f0f9ff;
      border-radius: 12px;
      text-align: center;
      border: 1px solid #d1e7ff;
    }
    .amount-box strong {
      display: block;
      font-size: 13px;
      color: #2980b9;
    }
    .amount-box div {
      font-size: 19px;
      font-weight: bold;
      color: var(--primary-color);
      margin-top: 5px;
    }
    button {
      padding: 12px 16px;
      border: none;
      border-radius: 10px;
      cursor: pointer;
      font-size: 15px;
      font-weight: bold;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      transition: var(--transition);
    }
    button:hover {
      transform: translateY(-2px);
      box-shadow: 0 3px 8px rgba(0,0,0,0.1);
    }
    .btn-primary { background: var(--secondary-color); color: white; }
    .btn-success { background: var(--success-color); color: white; }
    .btn-danger { background: var(--danger-color); color: white; }
    .btn-warning { background: var(--warning-color); color: white; }
    .btn-whatsapp { background: #25D366; color: white; }
    .btn-print { background: #9b59b6; color: white; }
    .btn-email { background: #3b5998; color: white; }
    .btn-sms { background: #00bfa5; color: white; }
    .btn-label { background: #8e44ad; color: white; }
    .btn-complete { background: #2ecc71; color: white; }

    .action-buttons {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 12px;
      margin-top: 20px;
    }
    
    /* ×¡×’× ×•×Ÿ ××§×¦×•×¢×™ ×™×•×ª×¨ ×œ×”×“×¤×¡×” */
    .receipt, .label-preview {
      display: none;
      padding: 25px;
      margin-top: 25px;
      border: 1px solid #ddd;
      background: #ffffff;
      font-size: 14px;
      line-height: 1.4;
      border-radius: 12px;
      max-width: 100%;
      margin-left: auto;
      margin-right: auto;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
      position: relative;
    }
    
    .receipt::before, .label-preview::before {
      content: "";
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 4px;
      background: linear-gradient(to right, var(--secondary-color), var(--success-color));
      border-radius: 12px 12px 0 0;
    }
    
    .receipt h3, .label-preview h3 {
      text-align: center;
      margin-top: 0;
      margin-bottom: 12px;
      font-size: 20px;
      color: var(--primary-color);
      border-bottom: 2px solid var(--secondary-color);
      padding-bottom: 10px;
    }
    .receipt .doc-number, .label-preview .doc-number {
      text-align: center;
      font-weight: bold;
      color: var(--secondary-color);
      margin-bottom: 8px;
      font-size: 16px;
    }
    .receipt .doc-date, .label-preview .doc-date {
      text-align: center;
      font-size: 13px;
      color: #7f8c8d;
      margin-bottom: 15px;
    }
    .receipt hr, .label-preview hr {
      border: none;
      border-top: 1px solid #e1e8f0;
      margin: 15px 0;
    }
    .receipt .footer-text, .label-preview .footer-text {
      text-align: center;
      margin-top: 20px;
      font-weight: bold;
      font-size: 14px;
      color: var(--primary-color);
      padding-top: 10px;
      border-top: 1px dashed #ddd;
    }
    
    .receipt-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 15px;
      margin-bottom: 15px;
    }
    
    .receipt-item {
      margin-bottom: 10px;
    }
    
    .receipt-item strong {
      display: inline-block;
      min-width: 120px;
      color: var(--primary-color);
    }
    
    .label-preview {
      max-width: 250px;
      font-size: 12px;
      padding: 15px;
    }
    
    .label-preview .doc-number {
      font-size: 14px;
    }
    
    .saved-list, .search-results {
      margin-top: 20px;
      max-height: 400px;
      overflow-y: auto;
      border: 1px solid #eee;
      border-radius: 10px;
      padding: 15px;
      background: #fafafa;
    }
    .saved-item, .result-item {
      padding: 12px;
      background: white;
      border-radius: 8px;
      margin-bottom: 12px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.05);
      transition: var(--transition);
    }
    .saved-item:hover, .result-item:hover {
      box-shadow: 0 2px 6px rgba(0,0,0,0.1);
    }
    .saved-item:last-child, .result-item:last-child {
      margin-bottom: 0;
    }
    .item-header {
      display: flex;
      justify-content: space-between;
      font-weight: bold;
      color: var(--primary-color);
    }
    .item-meta {
      font-size: 13px;
      color: #7f8c8d;
      margin-top: 5px;
    }
    .item-actions {
      display: flex;
      gap: 8px;
      margin-top: 10px;
      flex-wrap: wrap;
    }
    .item-actions button {
      padding: 6px 10px;
      font-size: 13px;
      width: auto;
    }
    .status-badge {
      display: inline-block;
      padding: 2px 8px;
      border-radius: 12px;
      font-size: 12px;
      font-weight: bold;
      margin-right: 8px;
    }
    .status-completed {
      background: #d4edda;
      color: #155724;
    }
    
    .form-row {
      display: flex;
      gap: 15px;
      margin-bottom: 15px;
    }
    
    .form-row .form-group {
      flex: 1;
      margin-bottom: 0;
    }
    
    .loading-overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.7);
      z-index: 1000;
      justify-content: center;
      align-items: center;
      flex-direction: column;
      color: white;
    }
    
    .loading-spinner {
      border: 5px solid #f3f3f3;
      border-top: 5px solid var(--secondary-color);
      border-radius: 50%;
      width: 50px;
      height: 50px;
      animation: spin 1s linear infinite;
      margin-bottom: 15px;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    .notification {
      position: fixed;
      top: 20px;
      right: 20px;
      padding: 15px 20px;
      border-radius: 8px;
      color: white;
      font-weight: bold;
      z-index: 1001;
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
      transform: translateX(150%);
      transition: transform 0.3s ease;
    }
    
    .notification.show {
      transform: translateX(0);
    }
    
    .notification.success {
      background: var(--success-color);
    }
    
    .notification.error {
      background: var(--danger-color);
    }
    
    .notification.info {
      background: var(--secondary-color);
    }
    
    /* ×”×“×¤×¡×” ××©×•×›×œ×œ×ª */
    .print-options {
      background: #f8f9fa;
      border-radius: 10px;
      padding: 15px;
      margin: 15px 0;
      border: 1px solid #e9ecef;
    }
    
    .print-options h4 {
      margin-top: 0;
      margin-bottom: 10px;
      color: var(--primary-color);
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .print-type-selector {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
    }
    
    .print-option {
      flex: 1;
      min-width: 120px;
      padding: 12px;
      background: white;
      border: 2px solid #e9ecef;
      border-radius: 8px;
      cursor: pointer;
      text-align: center;
      transition: var(--transition);
    }
    
    .print-option:hover {
      border-color: var(--secondary-color);
    }
    
    .print-option.active {
      border-color: var(--secondary-color);
      background: #e3f2fd;
    }
    
    .print-option i {
      font-size: 20px;
      margin-bottom: 5px;
      display: block;
      color: var(--secondary-color);
    }
    
    .print-option .print-desc {
      font-size: 12px;
      color: #6c757d;
      margin-top: 5px;
    }

    /* ×”×“×¤×¡×” ××§×¦×•×¢×™×ª */
    @media print {
      body * { 
        visibility: hidden; 
      }
      .receipt, .receipt *, .label-preview, .label-preview * { 
        visibility: visible; 
      }
      .receipt, .label-preview {
        position: absolute;
        left: 0;
        top: 0;
        width: 100%;
        box-sizing: border-box;
        margin: 0;
        border: none;
        box-shadow: none;
        border-radius: 0;
      }
      .receipt::before, .label-preview::before {
        display: none;
      }
      .action-buttons, .refresh-btn, .tabs, .container > h1, .container > p,
      .print-options, .loading-overlay, .notification {
        display: none !important;
      }
      
      /* ×”×ª×××•×ª ×œ××“×¤×¡×ª ×˜×¨××™×ª 58mm */
      @media print and (max-width: 58mm) {
        .receipt {
          padding: 5px !important;
          font-size: 9px !important;
          max-width: 58mm !important;
        }
        .receipt h3 {
          font-size: 11px !important;
          margin-bottom: 5px !important;
        }
        .receipt .doc-number {
          font-size: 10px !important;
        }
        .receipt .doc-date {
          font-size: 8px !important;
        }
        .receipt-grid {
          grid-template-columns: 1fr;
          gap: 5px;
          margin-bottom: 8px;
        }
        .receipt-item {
          margin-bottom: 4px;
        }
        .receipt-item strong {
          min-width: 70px;
        }
        .label-preview {
          max-width: 58mm !important;
          padding: 5px !important;
          font-size: 8px !important;
        }
      }
      
      /* ×”×ª×××•×ª ×œ××“×¤×¡×ª ×˜×¨××™×ª 80mm */
      @media print and (min-width: 59mm) and (max-width: 80mm) {
        .receipt {
          padding: 8px !important;
          font-size: 10px !important;
          max-width: 80mm !important;
        }
        .receipt h3 {
          font-size: 14px !important;
          margin-bottom: 8px !important;
        }
        .receipt .doc-number {
          font-size: 12px !important;
        }
        .receipt .doc-date {
          font-size: 9px !important;
        }
        .receipt-grid {
          gap: 8px;
          margin-bottom: 10px;
        }
        .receipt-item {
          margin-bottom: 5px;
        }
        .receipt-item strong {
          min-width: 90px;
        }
        .label-preview {
          max-width: 80mm !important;
          padding: 8px !important;
          font-size: 9px !important;
        }
      }
      
      /* ×”×ª×××•×ª ×œ-A4 */
      @media print and (min-width: 81mm) {
        .receipt {
          padding: 20px !important;
          font-size: 14px !important;
          max-width: 100% !important;
        }
        .receipt h3 {
          font-size: 20px !important;
        }
        .receipt .doc-number {
          font-size: 16px !important;
        }
        .label-preview {
          max-width: 250px !important;
          padding: 15px !important;
          font-size: 12px !important;
        }
      }
    }
    
    @media (max-width: 768px) {
      .action-buttons {
        grid-template-columns: 1fr;
      }
      
      .receipt-grid {
        grid-template-columns: 1fr;
      }
      
      .form-row {
        flex-direction: column;
        gap: 0;
      }
      
      .print-type-selector {
        flex-direction: column;
      }
    }
  </style>
</head>
<body>
  <div class="refresh-btn" title="×¨×¢× ×Ÿ ×“×£" onclick="refreshPage()">
    <i class="fas fa-redo"></i>
  </div>

  <div class="loading-overlay" id="loadingOverlay">
    <div class="loading-spinner"></div>
    <p>×˜×•×¢×Ÿ...</p>
  </div>

  <div class="notification" id="notification"></div>

  <div class="container">
    <h1 class="main-title">×˜×•×¤×¡ ×ª×™×§×•×Ÿ</h1>
    <p class="sub-title">Mfix - ×§× ×™×•×Ÿ ×¢×–×¨×™××œ×™ ×¨××œ×”</p>

    <div class="tabs">
      <button class="tab-btn active" data-tab="form">×˜×•×¤×¡ ×ª×™×§×•×Ÿ</button>
      <button class="tab-btn" data-tab="saved">×©××™×¨×” ××§×•××™×ª</button>
      <button class="tab-btn" data-tab="search">×—×™×¤×•×© ××¡××›×™×</button>
      <button class="tab-btn" data-tab="complete">×ª×™×§×•×Ÿ ×”×•×©×œ×</button>
      <button class="tab-btn" data-tab="backup">×’×™×‘×•×™×™×</button>
    </div>

    <!-- ×˜××‘ 1: ×˜×•×¤×¡ ×ª×™×§×•×Ÿ -->
    <div id="form-tab" class="tab-content active">
      <form id="repairForm">
        <div class="form-row">
          <div class="form-group">
            <label for="customerName"><i class="fas fa-user"></i> ×©× ×œ×§×•×—:</label>
            <input type="text" id="customerName" required />
          </div>

          <div class="form-group">
            <label for="phone"><i class="fas fa-phone"></i> ××¡×¤×¨ ×˜×œ×¤×•×Ÿ:</label>
            <input type="tel" id="phone" required placeholder="×œ××©×œ: 050-1234567" />
          </div>
        </div>

        <div class="form-row">
          <div class="form-group">
            <label for="email"><i class="fas fa-envelope"></i> ××™××™×™×œ:</label>
            <input type="email" id="email" placeholder="×œ××©×œ: customer@example.com" />
          </div>

          <div class="form-group">
            <label for="deviceType"><i class="fas fa-mobile-alt"></i> ×¡×•×’ ××›×©×™×¨:</label>
            <select id="deviceType" required>
              <option value="">×‘×—×¨ ×¡×•×’ ××›×©×™×¨</option>
              <option value="smartphone">×¡×××¨×˜×¤×•×Ÿ</option>
              <option value="tablet">×˜××‘×œ×˜</option>
              <option value="laptop">××—×©×‘ × ×™×™×“</option>
              <option value="smartwatch">×©×¢×•×Ÿ ×—×›×</option>
              <option value="other">××—×¨</option>
            </select>
          </div>
        </div>

        <div class="form-group">
          <label for="deviceModel"><i class="fas fa-microchip"></i> ×“×’× ×”××›×©×™×¨:</label>
          <input type="text" id="deviceModel" required />
        </div>

        <div class="form-group">
          <label for="issueDescription"><i class="fas fa-exclamation-triangle"></i> ×ª×™××•×¨ ×ª×§×œ×”:</label>
          <textarea id="issueDescription" rows="4" required placeholder="×ª××¨ ××ª ×”×ª×§×œ×” ×‘××“×•×™×§..."></textarea>
        </div>

        <div class="form-row">
          <div class="form-group">
            <label for="devicePassword"><i class="fas fa-lock"></i> ×§×•×“/×¡×™×¡××ª ××›×©×™×¨ (×× ×§×™×™×):</label>
            <input type="text" id="devicePassword" placeholder="×œ××©×œ: 1234, ××• Face ID" />
          </div>

          <div class="form-group">
            <label for="estimatedTime"><i class="fas fa-clock"></i> ×–××Ÿ ×ª×™×§×•×Ÿ ××©×•×¢×¨:</label>
            <select id="estimatedTime">
              <option value="">×‘×—×¨ ×–××Ÿ ××©×•×¢×¨</option>
              <option value="1-2">1-2 ×™××™×</option>
              <option value="3-5">3-5 ×™××™×</option>
              <option value="1week">×¢×“ ×©×‘×•×¢</option>
              <option value="2weeks">×¢×“ ×©×‘×•×¢×™×™×</option>
              <option value="unknown">×œ× ×™×“×•×¢</option>
            </select>
          </div>
        </div>

        <div class="form-group">
          <label for="totalAmount"><i class="fas fa-coins"></i> ×¡×›×•× ×œ×ª×©×œ×•× (×›×•×œ×œ ××¢"× 18%):</label>
          <input type="number" id="totalAmount" step="0.01" min="0" required oninput="calculateNet()" placeholder="×œ××©×œ: 100" />
        </div>

        <div class="amounts">
          <div class="amount-box">
            <strong>×¡×›×•× ×œ×œ× ××¢"×</strong>
            <div id="netAmount">0.00 â‚ª</div>
          </div>
          <div class="amount-box">
            <strong>××¢"× (18%)</strong>
            <div id="vatAmount">0.00 â‚ª</div>
          </div>
        </div>

        <button type="button" class="btn-success" onclick="generateAndSaveForm()">
          <i class="fas fa-file-alt"></i> ×”×¦×’ ×˜×•×¤×¡
        </button>

        <!-- ××¤×©×¨×•×™×•×ª ×”×“×¤×¡×” ××©×•×›×œ×œ×•×ª -->
        <div id="printOptions" class="print-options" style="display: none;">
          <h4><i class="fas fa-print"></i> ×”×’×“×¨×•×ª ×”×“×¤×¡×”</h4>
          <p>×‘×—×¨ ×¡×•×’ ××“×¤×¡×ª ×œ×”×“×¤×¡×”:</p>
          <div class="print-type-selector">
            <div class="print-option active" data-type="58mm" onclick="selectPrintType('58mm')">
              <i class="fas fa-receipt"></i>
              <div>×˜×¨××™×ª 58mm</div>
              <div class="print-desc">××“×¤×¡×ª ×§×‘×œ×•×ª ×§×˜× ×”</div>
            </div>
            <div class="print-option" data-type="80mm" onclick="selectPrintType('80mm')">
              <i class="fas fa-receipt"></i>
              <div>×˜×¨××™×ª 80mm</div>
              <div class="print-desc">××“×¤×¡×ª ×§×‘×œ×•×ª ×¡×˜× ×“×¨×˜×™×ª</div>
            </div>
            <div class="print-option" data-type="a4" onclick="selectPrintType('a4')">
              <i class="fas fa-file-alt"></i>
              <div>××“×¤×¡×ª A4</div>
              <div class="print-desc">××“×¤×¡×ª ××©×¨×“×™×ª ×¨×’×™×œ×”</div>
            </div>
          </div>
        </div>

        <div class="action-buttons">
          <button type="button" class="btn-print" onclick="printReceipt()">
            <i class="fas fa-print"></i> ×”×“×¤×¡ ×˜×•×¤×¡
          </button>
          <button type="button" class="btn-label" onclick="printLabel()">
            <i class="fas fa-tag"></i> ×”×“×¤×¡ ×ª×•×•×™×ª
          </button>
          <button type="button" class="btn-danger" onclick="exportToPDF()">
            <i class="fas fa-file-pdf"></i> ×™×™×¦× ×œ-PDF
          </button>
          <button type="button" class="btn-primary" onclick="downloadReceiptImage()">
            <i class="fas fa-image"></i> ×”×•×¨×“ ×›×ª××•× ×”
          </button>
          <button type="button" class="btn-whatsapp" onclick="sendToWhatsApp()">
            <i class="fab fa-whatsapp"></i> ×©×œ×— ×œ×•×•××˜×¡××¤
          </button>
          <button type="button" class="btn-email" onclick="sendEmail()">
            <i class="fas fa-envelope"></i> ×©×œ×— ×‘×“×•×"×œ
          </button>
        </div>

        <div id="receipt" class="receipt"></div>
        <div id="labelPreview" class="label-preview"></div>
      </form>
    </div>

    <!-- ×˜××‘ 2: ×©××™×¨×” ××§×•××™×ª -->
    <div id="saved-tab" class="tab-content">
      <h3><i class="fas fa-database"></i> ×›×œ ×”××¡××›×™× ×”×©××•×¨×™×</h3>
      <div id="savedList" class="saved-list"></div>
      <div style="margin-top:15px; display:flex; gap:10px; flex-wrap: wrap;">
        <button type="button" class="btn-primary" onclick="loadAllReceipts()">
          <i class="fas fa-sync"></i> ×¨×¢× ×Ÿ ×¨×©×™××”
        </button>
        <button type="button" class="btn-warning" onclick="exportAllReceipts()">
          <i class="fas fa-file-export"></i> ×™×™×¦× ×›×œ ×”××¡××›×™×
        </button>
        <button type="button" class="btn-success" onclick="document.getElementById('importFile').click()">
          <i class="fas fa-file-import"></i> ×™×™×‘× ××¡××›×™×
        </button>
        <input type="file" id="importFile" accept=".json" style="display:none;" onchange="importReceipts(event)">
        <button type="button" class="btn-danger" onclick="clearAllData()">
          <i class="fas fa-trash"></i> × ×§×” ×›×œ ×”× ×ª×•× ×™×
        </button>
      </div>
    </div>

    <!-- ×˜××‘ 3: ×—×™×¤×•×© ××¡××›×™× -->
    <div id="search-tab" class="tab-content">
      <h3><i class="fas fa-search"></i> ×—×™×¤×•×© ××¡××›×™×</h3>
      
      <!-- ×¤×× ×œ ×—×™×¤×•×© ××ª×§×“× - × ×•×¡×£ ×¢×œ ×™×“×™ ×”×©×™×¤×•×¨×™× -->
      <div id="advancedSearchPanel" class="advanced-search-panel">
        <h4 style="margin-top: 0; color: #2c3e50;">ğŸ” ×—×™×¤×•×© ××ª×§×“×</h4>
        
        <div class="form-row">
          <div class="form-group">
            <label>×˜×•×•×— ×ª××¨×™×›×™×:</label>
            <input type="date" id="searchDateFrom" style="margin-bottom: 5px;">
            <input type="date" id="searchDateTo">
          </div>
          
          <div class="form-group">
            <label>×˜×•×•×— ×¡×›×•××™×:</label>
            <input type="number" id="searchMinAmount" placeholder="××™× ×™××•×" style="margin-bottom: 5px;">
            <input type="number" id="searchMaxAmount" placeholder="××§×¡×™××•×">
          </div>
        </div>
        
        <div class="form-group">
          <label>×¡×˜×˜×•×¡:</label>
          <select id="searchStatus" style="width: 100%;">
            <option value="all">×›×œ ×”×¡×˜×˜×•×¡×™×</option>
            <option value="completed">×”×•×©×œ×</option>
            <option value="pending">×‘×ª×”×œ×™×š</option>
          </select>
        </div>
        
        <div class="form-group">
          <label>×¡×•×’×™ ××›×©×™×¨×™×:</label>
          <div id="deviceTypeFilters" style="display: flex; flex-wrap: wrap; gap: 8px; margin-top: 5px;">
            <label style="display: flex; align-items: center; gap: 4px;">
              <input type="checkbox" value="smartphone" class="device-type-checkbox">
              ×¡×××¨×˜×¤×•×Ÿ
            </label>
            <label style="display: flex; align-items: center; gap: 4px;">
              <input type="checkbox" value="tablet" class="device-type-checkbox">
              ×˜××‘×œ×˜
            </label>
            <label style="display: flex; align-items: center; gap: 4px;">
              <input type="checkbox" value="laptop" class="device-type-checkbox">
              ××—×©×‘ × ×™×™×“
            </label>
            <label style="display: flex; align-items: center; gap: 4px;">
              <input type="checkbox" value="smartwatch" class="device-type-checkbox">
              ×©×¢×•×Ÿ ×—×›×
            </label>
            <label style="display: flex; align-items: center; gap: 4px;">
              <input type="checkbox" value="other" class="device-type-checkbox">
              ××—×¨
            </label>
          </div>
        </div>
        
        <button type="button" class="btn-primary" onclick="advancedSearchManager.applyFilters()" style="width: 100%;">
          <i class="fas fa-search"></i> ×—×¤×© ××ª×§×“×
        </button>
      </div>

      <!-- ×©×“×•×ª ×”×—×™×¤×•×© ×”××§×•×¨×™×™× -->
      <div class="search-group">
        <input type="text" id="searchByName" placeholder="×—×¤×© ×œ×¤×™ ×©× ×œ×§×•×—" />
      </div>
      <div class="search-group">
        <input type="text" id="searchByPhone" placeholder="×—×¤×© ×œ×¤×™ ×˜×œ×¤×•×Ÿ" />
      </div>
      <div class="search-group">
        <input type="text" id="searchByDevice" placeholder="×—×¤×© ×œ×¤×™ ×“×’× ××›×©×™×¨" />
      </div>
      <button type="button" class="btn-warning" onclick="searchReceipts()">
        <i class="fas fa-search"></i> ×—×¤×©
      </button>
      <div id="searchResults" class="search-results"></div>
    </div>

    <!-- ×˜××‘ 4: ×ª×™×§×•×Ÿ ×”×•×©×œ× -->
    <div id="complete-tab" class="tab-content">
      <h3><i class="fas fa-check-circle"></i> ×ª×™×§×•×Ÿ ×”×•×©×œ×</h3>
      <p>×‘×—×¨ ×˜×•×¤×¡ ×›×“×™ ×œ×©×œ×•×— ×”×•×“×¢×” ×œ×œ×§×•×— ×©×”××›×©×™×¨ ××•×›×Ÿ ×œ××™×¡×•×£.</p>
      
      <div class="form-group">
        <label for="completeDocId"><i class="fas fa-file-alt"></i> ×‘×—×¨ ××¡××š:</label>
        <select id="completeDocId" style="padding:12px; font-size:15px;"></select>
      </div>

      <div class="action-buttons">
        <button type="button" class="btn-whatsapp" onclick="sendCompletionWhatsApp()">
          <i class="fab fa-whatsapp"></i> ×©×œ×— ×œ×•×•××˜×¡××¤
        </button>
        <button type="button" class="btn-email" onclick="sendCompletionEmail()">
          <i class="fas fa-envelope"></i> ×©×œ×— ×‘×“×•×"×œ
        </button>
        <button type="button" class="btn-sms" onclick="sendCompletionSMS()">
          <i class="fas fa-sms"></i> ×©×œ×— SMS
        </button>
      </div>
    </div>

    <!-- ×˜××‘ 5: ×’×™×‘×•×™×™× -->
    <div id="backup-tab" class="tab-content">
      <h3><i class="fas fa-database"></i> ××¢×¨×›×ª ×’×™×‘×•×™×™×</h3>
      
      <div style="background: #f0f9ff; border-radius: 10px; padding: 15px; margin-bottom: 20px; border: 1px solid #d1e7ff;">
        <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap;">
          <div>
            <h4 style="margin: 0 0 5px 0; color: #0369a1;">×’×™×‘×•×™ ××•×˜×•××˜×™</h4>
            <p style="margin: 0; color: #64748b; font-size: 14px;">
              ×”×’×™×‘×•×™ ××ª×‘×¦×¢ ××•×˜×•××˜×™×ª ×›×œ 10 ×“×§×•×ª. 
              <span id="backupStatus"><i class="fas fa-database"></i> ×˜×•×¢×Ÿ...</span>
            </p>
          </div>
          <div style="display: flex; gap: 10px; margin-top: 10px;">
            <button type="button" class="btn-success" onclick="manualBackup()">
              <i class="fas fa-save"></i> ×’×™×‘×•×™ ×¢×›×©×™×•
            </button>
            <button type="button" class="btn-warning" onclick="startBackupSystem()">
              <i class="fas fa-play"></i> ×”×¤×¢×œ ×’×™×‘×•×™
            </button>
            <button type="button" class="btn-danger" onclick="stopBackupSystem()">
              <i class="fas fa-stop"></i> ×¢×¦×•×¨ ×’×™×‘×•×™
            </button>
          </div>
        </div>
      </div>

      <!-- ×©×œ×™×—×ª ×’×™×‘×•×™ ×œ××™×™×œ -->
      <div style="background: #fff3e0; border-radius: 10px; padding: 15px; margin: 20px 0; border: 1px solid #ffb74d;">
        <h4 style="margin: 0 0 10px 0; color: #e65100; display: flex; align-items: center; gap: 8px;">
          <i class="fas fa-paper-plane"></i> ×©×œ×™×—×ª ×’×™×‘×•×™ ×œ××™×™×œ
        </h4>
        <div class="form-group">
          <label for="backupEmail"><i class="fas fa-envelope"></i> ×›×ª×•×‘×ª ××™×™×œ:</label>
          <input type="email" id="backupEmail" placeholder="×œ××©×œ: your@email.com" style="margin-bottom: 10px;" />
        </div>
        <button type="button" class="btn-warning" onclick="sendBackupToEmail()">
          <i class="fas fa-paper-plane"></i> ×©×œ×— ×’×™×‘×•×™ ×œ××™×™×œ
        </button>
      </div>

      <!-- ×¡×˜×˜×™×¡×˜×™×§×•×ª ××›×™×¨×•×ª -->
      <div style="background: #f0f4ff; border-radius: 10px; padding: 15px; margin: 20px 0; border: 1px solid #3f51b5;">
        <h4 style="margin: 0 0 10px 0; color: #1a237e; display: flex; align-items: center; gap: 8px;">
          <i class="fas fa-chart-bar"></i> ×¡×˜×˜×™×¡×˜×™×§×•×ª ××›×™×¨×•×ª
        </h4>
        
        <div id="salesStats" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 15px;">
          <!-- ×”×¡×˜×˜×™×¡×˜×™×§×•×ª ×™×•×˜×¢× ×• ×›××Ÿ -->
        </div>
        
        <div style="display: flex; gap: 10px; flex-wrap: wrap;">
          <button type="button" class="btn-primary" onclick="updateSalesStats()">
            <i class="fas fa-sync"></i> ×¨×¢× ×Ÿ ×¡×˜×˜×™×¡×˜×™×§×•×ª
          </button>
          <button type="button" class="btn-success" onclick="exportSalesReport()">
            <i class="fas fa-file-excel"></i> ×™×™×¦× ×“×•×— ××›×™×¨×•×ª
          </button>
        </div>
      </div>

      <div style="display: flex; gap: 10px; margin-bottom: 20px; flex-wrap: wrap;">
        <button type="button" class="btn-primary" onclick="showBackupsList()">
          <i class="fas fa-sync"></i> ×¨×¢× ×Ÿ ×¨×©×™××”
        </button>
        <button type="button" class="btn-warning" onclick="document.getElementById('importBackupFile').click()">
          <i class="fas fa-file-import"></i> ×™×™×‘× ×’×™×‘×•×™
        </button>
        <input type="file" id="importBackupFile" accept=".json" style="display:none;" onchange="importBackupFile(event)">
      </div>

      <div id="backupsList" class="saved-list"></div>
    </div>
  </div>

  <!-- ×”×§×•×“ ×”××§×•×¨×™ ×©×œ×š -->
  <script>
    // === ××¢×¨×›×ª ×’×™×‘×•×™ ××•×˜×•××˜×™×ª ===
    let backupInterval;

    // ××ª×—×•×œ ××¢×¨×›×ª ×”×’×™×‘×•×™
    function initBackupSystem() {
      // ×”×¤×¢×œ×ª ×’×™×‘×•×™ ××•×˜×•××˜×™ ×›×œ 10 ×“×§×•×ª
      backupInterval = setInterval(autoBackup, 10 * 60 * 1000);
      
      // ×’×™×‘×•×™ ×¨××©×•× ×™ ×‘×¢×ª ×˜×¢×™× ×ª ×”×“×£
      setTimeout(autoBackup, 2000);
      
      // ×”×¦×’×ª ××¡×¤×¨ ×”×’×™×‘×•×™×™× ×”×§×™×™××™×
      updateBackupStatus();
    }

    // ×’×™×‘×•×™ ××•×˜×•××˜×™
    function autoBackup() {
      const receipts = getReceiptsFromStorage();
      if (receipts.length === 0) return;
      
      const backupData = {
        timestamp: new Date().toISOString(),
        date: new Date().toLocaleString('he-IL'),
        count: receipts.length,
        data: receipts
      };
      
      saveBackup(backupData);
      console.log(`×’×™×‘×•×™ ××•×˜×•××˜×™ ×‘×•×¦×¢: ${backupData.date} (${receipts.length} ××¡××›×™×)`);
    }

    // ×©××™×¨×ª ×’×™×‘×•×™
    function saveBackup(backupData) {
      try {
        const backups = getBackupsFromStorage();
        
        // ×”×’×‘×œ×ª ××¡×¤×¨ ×”×’×™×‘×•×™×™× ×œ-50 ×”××—×¨×•× ×™×
        backups.unshift(backupData);
        if (backups.length > 50) {
          backups.splice(50);
        }
        
        localStorage.setItem('mfix_backups', JSON.stringify(backups));
        updateBackupStatus();
      } catch (e) {
        console.error("×©×’×™××” ×‘×©××™×¨×ª ×”×’×™×‘×•×™:", e);
      }
    }

    // ×˜×¢×™× ×ª ×’×™×‘×•×™×™× ××”××—×¡×•×Ÿ
    function getBackupsFromStorage() {
      try {
        const stored = localStorage.getItem('mfix_backups');
        return stored ? JSON.parse(stored) : [];
      } catch (e) {
        console.error("×©×’×™××” ×‘×˜×¢×™× ×ª ×”×’×™×‘×•×™×™×:", e);
        return [];
      }
    }

    // ×¢×“×›×•×Ÿ ××¦×‘ ×”×’×™×‘×•×™×™×
    function updateBackupStatus() {
      const backups = getBackupsFromStorage();
      const statusElement = document.getElementById('backupStatus');
      
      if (statusElement) {
        if (backups.length > 0) {
          const latest = backups[0];
          statusElement.innerHTML = `
            <i class="fas fa-database"></i> 
            ×’×™×‘×•×™×™×: ${backups.length} | ××—×¨×•×Ÿ: ${latest.date}
          `;
        } else {
          statusElement.innerHTML = `<i class="fas fa-database"></i> ××™×Ÿ ×’×™×‘×•×™×™×`;
        }
      }
    }

    // ×’×™×‘×•×™ ×™×“× ×™
    function manualBackup() {
      showLoading(true);
      
      setTimeout(() => {
        autoBackup();
        showNotification("×’×™×‘×•×™ ×™×“× ×™ ×‘×•×¦×¢ ×‘×”×¦×œ×—×”!", "success");
        showLoading(false);
      }, 500);
    }

    // ×”×¦×’×ª ×¨×©×™××ª ×’×™×‘×•×™×™×
    function showBackupsList() {
      const backups = getBackupsFromStorage();
      const container = document.getElementById('backupsList');
      
      if (!container) return;
      
      if (backups.length === 0) {
        container.innerHTML = '<p style="text-align:center; color:#7f8c8d; padding:20px;">××™×Ÿ ×’×™×‘×•×™×™× ×–××™× ×™×.</p>';
        return;
      }
      
      let html = '';
      backups.forEach((backup, index) => {
        const receiptCount = backup.data ? backup.data.length : 0;
        const size = JSON.stringify(backup).length;
        const sizeKB = (size / 1024).toFixed(1);
        
        html += `
          <div class="saved-item">
            <div class="item-header">
              <span>×’×™×‘×•×™ ${index + 1} - ${backup.date}</span>
              <span>${receiptCount} ××¡××›×™×</span>
            </div>
            <div class="item-meta">
              ğŸ“Š ×’×•×“×œ: ${sizeKB} KB | ğŸ•’ ${backup.date}
            </div>
            <div class="item-actions">
              <button class="btn-success" onclick="restoreFromBackup(${index})">
                <i class="fas fa-undo"></i> ×©×—×–×¨
              </button>
              <button class="btn-primary" onclick="downloadBackup(${index})">
                <i class="fas fa-download"></i> ×”×•×¨×“
              </button>
              <button class="btn-danger" onclick="deleteBackup(${index})">
                <i class="fas fa-trash"></i> ××—×§
              </button>
            </div>
          </div>
        `;
      });
      
      container.innerHTML = html;
      updateSalesStats(); // ×¢×“×›×Ÿ ×¡×˜×˜×™×¡×˜×™×§×•×ª ××•×˜×•××˜×™×ª
    }

    // ×©×—×–×•×¨ ××’×™×‘×•×™
    function restoreFromBackup(index) {
      if (!confirm("×”×× ××ª×” ×‘×˜×•×— ×©×‘×¨×¦×•× ×š ×œ×©×—×–×¨ ××’×™×‘×•×™ ×–×”? ×›×œ ×”× ×ª×•× ×™× ×”× ×•×›×—×™×™× ×™×™××—×§×•!")) {
        return;
      }
      
      const backups = getBackupsFromStorage();
      if (index < 0 || index >= backups.length) {
        showNotification("×’×™×‘×•×™ ×œ× × ××¦×.", "error");
        return;
      }
      
      const backup = backups[index];
      if (!backup.data || !Array.isArray(backup.data)) {
        showNotification("× ×ª×•× ×™ ×”×’×™×‘×•×™ ×¤×’×•××™×.", "error");
        return;
      }
      
      try {
        saveReceiptsToStorage(backup.data);
        showNotification(`×©×•×—×–×¨×• ${backup.data.length} ××¡××›×™× ××’×™×‘×•×™ ${backup.date}`, "success");
        loadAllReceipts();
      } catch (e) {
        console.error("×©×’×™××” ×‘×©×—×–×•×¨:", e);
        showNotification("×©×’×™××” ×‘×©×—×–×•×¨ ×”×’×™×‘×•×™", "error");
      }
    }

    // ×”×•×¨×“×ª ×’×™×‘×•×™ ×›×§×•×‘×¥
    function downloadBackup(index) {
      const backups = getBackupsFromStorage();
      if (index < 0 || index >= backups.length) {
        showNotification("×’×™×‘×•×™ ×œ× × ××¦×.", "error");
        return;
      }
      
      const backup = backups[index];
      const jsonString = JSON.stringify(backup, null, 2);
      const blob = new Blob([jsonString], { type: 'application/json;charset=utf-8;' });
      const url = URL.createObjectURL(blob);
      
      const link = document.createElement('a');
      link.href = url;
      link.setAttribute('download', `Mfix_Backup_${backup.date.replace(/[/:\\]/g, '_')}.json`);
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
      URL.revokeObjectURL(url);
      
      showNotification("×’×™×‘×•×™ ×”×•×¨×“ ×‘×”×¦×œ×—×”", "success");
    }

    // ××—×™×§×ª ×’×™×‘×•×™
    function deleteBackup(index) {
      if (!confirm("×”×× ××ª×” ×‘×˜×•×— ×©×‘×¨×¦×•× ×š ×œ××—×•×§ ×’×™×‘×•×™ ×–×”?")) return;
      
      const backups = getBackupsFromStorage();
      if (index < 0 || index >= backups.length) {
        showNotification("×’×™×‘×•×™ ×œ× × ××¦×.", "error");
        return;
      }
      
      backups.splice(index, 1);
      localStorage.setItem('mfix_backups', JSON.stringify(backups));
      showNotification("×’×™×‘×•×™ × ××—×§", "success");
      showBackupsList();
      updateBackupStatus();
    }

    // ×™×™×‘×•× ×’×™×‘×•×™ ××§×•×‘×¥
    function importBackupFile(event) {
      const file = event.target.files[0];
      if (!file) return;
      
      const reader = new FileReader();
      reader.onload = function(e) {
        try {
          const backupData = JSON.parse(e.target.result);
          
          if (!backupData.data || !Array.isArray(backupData.data)) {
            throw new Error("×¤×•×¨××˜ ×§×•×‘×¥ ×’×™×‘×•×™ ×œ× ×ª×§×™×Ÿ");
          }
          
          // ×”×•×¡×¤×ª ×ª××¨×™×š × ×•×›×—×™ ×× ×—×¡×¨
          if (!backupData.timestamp) {
            backupData.timestamp = new Date().toISOString();
          }
          if (!backupData.date) {
            backupData.date = new Date().toLocaleString('he-IL');
          }
          if (!backupData.count) {
            backupData.count = backupData.data.length;
          }
          
          saveBackup(backupData);
          showNotification("×’×™×‘×•×™ ×™×•×‘× ×‘×”×¦×œ×—×”!", "success");
          showBackupsList();
          
        } catch (err) {
          console.error(err);
          showNotification("×©×’×™××” ×‘×™×‘×•× ×”×’×™×‘×•×™. ×•×“× ×©×–×” ×§×•×‘×¥ ×’×™×‘×•×™ ×ª×§×™×Ÿ.", "error");
        }
      };
      reader.readAsText(file);
      event.target.value = '';
    }

    // ×¢×¦×™×¨×ª ××¢×¨×›×ª ×”×’×™×‘×•×™ (×œ××§×¨×” ×©×œ ×¦×•×¨×š)
    function stopBackupSystem() {
      if (backupInterval) {
        clearInterval(backupInterval);
        showNotification("××¢×¨×›×ª ×”×’×™×‘×•×™ ×”××•×˜×•××˜×™ ×”×•×¤×¡×§×”", "info");
      }
    }

    // ×”×¤×¢×œ×ª ××¢×¨×›×ª ×”×’×™×‘×•×™ ××—×“×©
    function startBackupSystem() {
      if (backupInterval) {
        clearInterval(backupInterval);
      }
      initBackupSystem();
      showNotification("××¢×¨×›×ª ×”×’×™×‘×•×™ ×”××•×˜×•××˜×™ ×”×•×¤×¢×œ×”", "success");
    }

    // === ×¤×•× ×§×¦×™×•×ª ×œ×©×œ×™×—×ª ×’×™×‘×•×™ ×œ××™×™×œ ===
    function sendBackupToEmail() {
      const email = document.getElementById('backupEmail').value.trim();
      if (!email) {
        showNotification("× × ×”×–×Ÿ ×›×ª×•×‘×ª ××™×™×œ.", "error");
        return;
      }

      if (!validateEmail(email)) {
        showNotification("×›×ª×•×‘×ª ×”××™×™×œ ××™× ×” ×ª×§×™× ×”.", "error");
        return;
      }

      showLoading(true);
      
      try {
        const receipts = getReceiptsFromStorage();
        if (receipts.length === 0) {
          showNotification("××™×Ÿ × ×ª×•× ×™× ×œ×’×™×‘×•×™.", "error");
          showLoading(false);
          return;
        }

        const backupData = {
          timestamp: new Date().toISOString(),
          date: new Date().toLocaleString('he-IL'),
          count: receipts.length,
          data: receipts
        };

        const jsonString = JSON.stringify(backupData, null, 2);
        const blob = new Blob([jsonString], { type: 'application/json;charset=utf-8;' });
        
        // ×™×¦×™×¨×ª ×§×•×‘×¥ ×œ×”×•×¨×“×” ×‘××§×•× ×©×œ×™×—×” ××•×˜×•××˜×™×ª
        const url = URL.createObjectURL(blob);
        const link = document.createElement('a');
        link.href = url;
        link.setAttribute('download', `Mfix_Backup_${backupData.date.replace(/[/:\\]/g, '_')}.json`);
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        URL.revokeObjectURL(url);

        // ×¤×ª×™×—×ª ×“×•××¨ ×¢× ×¤×¨×˜×™×
        const subject = `×’×™×‘×•×™ × ×ª×•× ×™× - Mfix - ${backupData.date}`;
        const body = 
          `×’×™×‘×•×™ × ×ª×•× ×™× ××•×˜×•××˜×™×ª ×××¢×¨×›×ª Mfix\n\n` +
          `×ª××¨×™×š: ${backupData.date}\n` +
          `××¡×¤×¨ ××¡××›×™×: ${backupData.count}\n\n` +
          `×§×•×‘×¥ ×”×’×™×‘×•×™ ×”×•×¨×“ ××•×˜×•××˜×™×ª. ×× × ×¦×¨×£ ××ª ×”×§×•×‘×¥ ×œ×”×•×¨×“×” ×œ××™×™×œ ×–×”.\n\n` +
          `× ×ª×•× ×™ ×”×’×™×‘×•×™:\n` +
          `- ${backupData.count} ××¡××›×™ ×ª×™×§×•×Ÿ\n` +
          `- ×¡×”"×› ×œ×§×•×—×•×ª: ${new Set(receipts.map(r => r.customerName)).size}\n` +
          `- ×¡×”"×› ×”×›× ×¡×•×ª: ${receipts.reduce((sum, r) => sum + r.totalAmount, 0).toFixed(2)} â‚ª\n\n` +
          `×ª×•×“×”,\n×¦×•×•×ª Mfix`;

        window.location.href = `mailto:${email}?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;

        showLoading(false);
        showNotification(`×’×™×‘×•×™ ×”×•×¨×“ ×•× ×©×œ×— ×‘×”×¦×œ×—×” ×œ××™×™×œ: ${email}`, "success");

      } catch (error) {
        console.error("×©×’×™××” ×‘×©×œ×™×—×ª ×”×’×™×‘×•×™ ×œ××™×™×œ:", error);
        showLoading(false);
        showNotification("×©×’×™××” ×‘×©×œ×™×—×ª ×”×’×™×‘×•×™ ×œ××™×™×œ", "error");
      }
    }

    function validateEmail(email) {
      const re = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
      return re.test(email);
    }

    // === ×¤×•× ×§×¦×™×•×ª ×œ×¡×˜×˜×™×¡×˜×™×§×•×ª ××›×™×¨×•×ª ===
    function updateSalesStats() {
      const receipts = getReceiptsFromStorage();
      const stats = calculateSalesStats(receipts);
      displaySalesStats(stats);
    }

    function calculateSalesStats(receipts) {
      if (receipts.length === 0) {
        return {
          totalReceipts: 0,
          totalRevenue: 0,
          averageReceipt: 0,
          completedRepairs: 0,
          pendingRepairs: 0,
          monthlyRevenue: 0,
          deviceTypes: {},
          monthlyStats: {}
        };
      }

      const now = new Date();
      const currentMonth = now.getMonth();
      const currentYear = now.getFullYear();

      let totalRevenue = 0;
      let completedRepairs = 0;
      let monthlyRevenue = 0;
      const deviceTypes = {};
      const monthlyStats = {};

      receipts.forEach(receipt => {
        totalRevenue += receipt.totalAmount;
        
        if (receipt.completed) {
          completedRepairs++;
        }

        // ×¡×˜×˜×™×¡×˜×™×§×•×ª ×œ×¤×™ ×¡×•×’ ××›×©×™×¨
        const deviceType = receipt.deviceType || 'other';
        deviceTypes[deviceType] = (deviceTypes[deviceType] || 0) + 1;

        // ×¡×˜×˜×™×¡×˜×™×§×•×ª ×—×•×“×©×™×•×ª
        try {
          const receiptDate = new Date(receipt.timestamp);
          const monthKey = `${receiptDate.getMonth() + 1}/${receiptDate.getFullYear()}`;
          
          if (!monthlyStats[monthKey]) {
            monthlyStats[monthKey] = { count: 0, revenue: 0 };
          }
          monthlyStats[monthKey].count++;
          monthlyStats[monthKey].revenue += receipt.totalAmount;

          // ×”×›× ×¡×” ×—×•×“×©×™×ª × ×•×›×—×™×ª
          if (receiptDate.getMonth() === currentMonth && receiptDate.getFullYear() === currentYear) {
            monthlyRevenue += receipt.totalAmount;
          }
        } catch (e) {
          console.error("Error parsing receipt date:", e);
        }
      });

      return {
        totalReceipts: receipts.length,
        totalRevenue: totalRevenue,
        averageReceipt: totalRevenue / receipts.length,
        completedRepairs: completedRepairs,
        pendingRepairs: receipts.length - completedRepairs,
        monthlyRevenue: monthlyRevenue,
        deviceTypes: deviceTypes,
        monthlyStats: monthlyStats
      };
    }

    function displaySalesStats(stats) {
      const container = document.getElementById('salesStats');
      
      if (stats.totalReceipts === 0) {
        container.innerHTML = '<p style="text-align:center; color:#7f8c8d; grid-column: 1 / -1;">××™×Ÿ × ×ª×•× ×™× ×œ×”×¦×’×”</p>';
        return;
      }

      const deviceTypeNames = {
        'smartphone': '×¡×××¨×˜×¤×•×Ÿ',
        'tablet': '×˜××‘×œ×˜',
        'laptop': '××—×©×‘ × ×™×™×“',
        'smartwatch': '×©×¢×•×Ÿ ×—×›×',
        'other': '××—×¨'
      };

      let deviceTypesHtml = '';
      Object.entries(stats.deviceTypes).forEach(([type, count]) => {
        const percentage = ((count / stats.totalReceipts) * 100).toFixed(1);
        deviceTypesHtml += `<div>${deviceTypeNames[type] || type}: ${count} (${percentage}%)</div>`;
      });

      container.innerHTML = `
        <div class="amount-box">
          <strong>×¡×”"×› ×ª×™×§×•× ×™×</strong>
          <div>${stats.totalReceipts}</div>
        </div>
        <div class="amount-box">
          <strong>×¡×”"×› ×”×›× ×¡×•×ª</strong>
          <div>${stats.totalRevenue.toFixed(2)} â‚ª</div>
        </div>
        <div class="amount-box">
          <strong>×”×›× ×¡×” ×××•×¦×¢×ª</strong>
          <div>${stats.averageReceipt.toFixed(2)} â‚ª</div>
        </div>
        <div class="amount-box">
          <strong>×ª×™×§×•× ×™× ×©×”×•×©×œ××•</strong>
          <div>${stats.completedRepairs}</div>
        </div>
        <div class="amount-box">
          <strong>×ª×™×§×•× ×™× ×‘×”××ª× ×”</strong>
          <div>${stats.pendingRepairs}</div>
        </div>
        <div class="amount-box">
          <strong>×”×›× ×¡×” ×—×•×“×©×™×ª</strong>
          <div>${stats.monthlyRevenue.toFixed(2)} â‚ª</div>
        </div>
        <div style="grid-column: 1 / -1; background: white; padding: 10px; border-radius: 8px; border: 1px solid #e1e8f0;">
          <strong>×¡×•×’×™ ××›×©×™×¨×™×:</strong>
          ${deviceTypesHtml}
        </div>
      `;
    }

    function exportSalesReport() {
      const receipts = getReceiptsFromStorage();
      const stats = calculateSalesStats(receipts);
      
      if (stats.totalReceipts === 0) {
        showNotification("××™×Ÿ × ×ª×•× ×™× ×œ×™×¦×•×.", "error");
        return;
      }

      let csvContent = "×“×•×— ××›×™×¨×•×ª - Mfix\n\n";
      csvContent += `×ª××¨×™×š ×™×¦×•×: ${new Date().toLocaleString('he-IL')}\n\n`;
      
      csvContent += "×¡×˜×˜×™×¡×˜×™×§×•×ª ×›×œ×œ×™×•×ª:\n";
      csvContent += `×¡×”"×› ×ª×™×§×•× ×™×,${stats.totalReceipts}\n`;
      csvContent += `×¡×”"×› ×”×›× ×¡×•×ª,${stats.totalRevenue.toFixed(2)}\n`;
      csvContent += `×”×›× ×¡×” ×××•×¦×¢×ª,${stats.averageReceipt.toFixed(2)}\n`;
      csvContent += `×ª×™×§×•× ×™× ×©×”×•×©×œ××•,${stats.completedRepairs}\n`;
      csvContent += `×ª×™×§×•× ×™× ×‘×”××ª× ×”,${stats.pendingRepairs}\n`;
      csvContent += `×”×›× ×¡×” ×—×•×“×©×™×ª,${stats.monthlyRevenue.toFixed(2)}\n\n`;
      
      csvContent += "×¡×•×’×™ ××›×©×™×¨×™×:\n";
      csvContent += "×¡×•×’ ××›×©×™×¨,×›××•×ª,××—×•×–×™×\n";
      Object.entries(stats.deviceTypes).forEach(([type, count]) => {
        const percentage = ((count / stats.totalReceipts) * 100).toFixed(1);
        const typeName = {
          'smartphone': '×¡×××¨×˜×¤×•×Ÿ',
          'tablet': '×˜××‘×œ×˜',
          'laptop': '××—×©×‘ × ×™×™×“',
          'smartwatch': '×©×¢×•×Ÿ ×—×›×',
          'other': '××—×¨'
        }[type] || type;
        csvContent += `${typeName},${count},${percentage}%\n`;
      });
      
      csvContent += "\n×¡×˜×˜×™×¡×˜×™×§×•×ª ×—×•×“×©×™×•×ª:\n";
      csvContent += "×—×•×“×©,××¡×¤×¨ ×ª×™×§×•× ×™×,×”×›× ×¡×•×ª\n";
      Object.entries(stats.monthlyStats).forEach(([month, data]) => {
        csvContent += `${month},${data.count},${data.revenue.toFixed(2)}\n`;
      });

      const blob = new Blob(['\uFEFF' + csvContent], { type: 'text/csv;charset=utf-8;' });
      const url = URL.createObjectURL(blob);
      
      const link = document.createElement('a');
      link.href = url;
      link.setAttribute('download', `×“×•×—_××›×™×¨×•×ª_Mfix_${new Date().toLocaleDateString('he-IL').replace(/\//g, '-')}.csv`);
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
      URL.revokeObjectURL(url);
      
      showNotification("×“×•×— ××›×™×¨×•×ª ×™×•×¦× ×‘×”×¦×œ×—×”", "success");
    }

    // === ×”×’×“×¨×•×ª ×”×“×¤×¡×” ===
    let currentPrintType = '58mm'; // ×‘×¨×™×¨×ª ××—×“×œ
    
    function selectPrintType(type) {
      currentPrintType = type;
      
      // ×”×¡×¨×ª ×¡×™××•×Ÿ ×¤×¢×™×œ ××›×œ ×”××¤×©×¨×•×™×•×ª
      document.querySelectorAll('.print-option').forEach(option => {
        option.classList.remove('active');
      });
      
      // ×¡×™××•×Ÿ ×”××¤×©×¨×•×ª ×”× ×‘×—×¨×ª
      document.querySelector(`.print-option[data-type="${type}"]`).classList.add('active');
      
      showNotification(`×¡×•×’ ×”×“×¤×¡×” × ×‘×—×¨: ${getPrintTypeName(type)}`, 'info', 2000);
    }
    
    function getPrintTypeName(type) {
      const names = {
        '58mm': '×˜×¨××™×ª 58mm',
        '80mm': '×˜×¨××™×ª 80mm',
        'a4': '××“×¤×¡×ª A4'
      };
      return names[type] || type;
    }
    
    function applyPrintStyles(element, type) {
      // ××™×¤×•×¡ ×¡×’× ×•× ×•×ª
      element.style.maxWidth = '';
      element.style.padding = '';
      element.style.fontSize = '';
      
      switch(type) {
        case '58mm':
          element.style.maxWidth = '58mm';
          element.style.padding = '5px';
          element.style.fontSize = '9px';
          break;
        case '80mm':
          element.style.maxWidth = '80mm';
          element.style.padding = '8px';
          element.style.fontSize = '10px';
          break;
        case 'a4':
          element.style.maxWidth = '100%';
          element.style.padding = '20px';
          element.style.fontSize = '14px';
          break;
      }
    }

    // === ×¤×•× ×§×¦×™×•×ª × ×™×”×•×œ ××¦×‘ ===
    function showLoading(show) {
      document.getElementById('loadingOverlay').style.display = show ? 'flex' : 'none';
    }
    
    function showNotification(message, type = 'info', duration = 3000) {
      const notification = document.getElementById('notification');
      notification.textContent = message;
      notification.className = `notification ${type}`;
      notification.classList.add('show');
      
      setTimeout(() => {
        notification.classList.remove('show');
      }, duration);
    }
    
    function encryptData(data) {
      // ×”×¦×¤× ×” ×‘×¡×™×¡×™×ª - × ×™×ª×Ÿ ×œ×©×¤×¨ ×¢× ×¡×¤×¨×™×•×ª ×”×¦×¤× ×” ××ª×§×“××•×ª
      try {
        return btoa(unescape(encodeURIComponent(JSON.stringify(data))));
      } catch (e) {
        console.error("×©×’×™××” ×‘×”×¦×¤× ×ª ×”× ×ª×•× ×™×:", e);
        return JSON.stringify(data);
      }
    }
    
    function decryptData(encryptedData) {
      try {
        return JSON.parse(decodeURIComponent(escape(atob(encryptedData))));
      } catch (e) {
        console.error("×©×’×™××” ×‘×¤×¢× ×•×— ×”× ×ª×•× ×™×:", e);
        try {
          return JSON.parse(encryptedData);
        } catch (e2) {
          return null;
        }
      }
    }
    
    // === ×¤×•× ×§×¦×™×™×ª ×”××¨×” ×œ×¤×•×¨××˜ ×‘×™× ×œ××•××™ ===
    function formatIsraeliPhone(phone) {
      let clean = phone.replace(/\D/g, '');
      if (clean.startsWith('00')) clean = clean.substring(2);
      if (clean.startsWith('972')) return clean;
      if (clean.startsWith('0')) return '972' + clean.substring(1);
      if (clean.length === 9 && clean.startsWith('5')) return '972' + clean;
      return clean;
    }

    // === ×¨×¢× ×•×Ÿ ===
    function refreshPage() {
      if (confirm("×”×× ××ª×” ×‘×˜×•×— ×©×‘×¨×¦×•× ×š ×œ×¨×¢× ×Ÿ ××ª ×”×“×£? ×›×œ ×©×™× ×•×™ ×©×œ× × ×©××¨ ×™××‘×“.")) {
        location.reload();
      }
    }
    
    // === × ×§×™×™×ª ×›×œ ×”× ×ª×•× ×™× ===
    function clearAllData() {
      if (confirm("×”×× ××ª×” ×‘×˜×•×— ×©×‘×¨×¦×•× ×š ×œ××—×•×§ ××ª ×›×œ ×”× ×ª×•× ×™×? ×¤×¢×•×œ×” ×–×• ××™× ×” × ×™×ª× ×ª ×œ×‘×™×˜×•×œ!")) {
        localStorage.removeItem('mfix_receipts');
        showNotification('×›×œ ×”× ×ª×•× ×™× × ××—×§×• ×‘×”×¦×œ×—×”', 'success');
        loadAllReceipts();
      }
    }

    // === ×˜××‘×™× ===
    document.querySelectorAll('.tab-btn').forEach(button => {
      button.addEventListener('click', () => {
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
        button.classList.add('active');
        const tabId = button.getAttribute('data-tab');
        document.getElementById(tabId + '-tab').classList.add('active');
        
        if (tabId === 'saved') loadAllReceipts();
        if (tabId === 'complete') loadCompletionDropdown();
        if (tabId === 'backup') showBackupsList();
      });
    });

    // === ×¤×•× ×§×¦×™×•×ª ×¢×–×¨ ===
    function calculateNet() {
      const total = parseFloat(document.getElementById('totalAmount').value) || 0;
      if (total <= 0) {
        document.getElementById('netAmount').textContent = '0.00 â‚ª';
        document.getElementById('vatAmount').textContent = '0.00 â‚ª';
        return;
      }
      const net = total / 1.18;
      const vat = total - net;
      document.getElementById('netAmount').textContent = net.toFixed(2) + ' â‚ª';
      document.getElementById('vatAmount').textContent = vat.toFixed(2) + ' â‚ª';
    }

    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    function getNextDocNumber() {
      const receipts = getReceiptsFromStorage();
      if (receipts.length === 0) return 1345;
      const last = Math.max(...receipts.map(r => r.docNumber || 0));
      return last + 1;
    }
    
    function getReceiptsFromStorage() {
      try {
        const stored = localStorage.getItem('mfix_receipts');
        if (!stored) return [];
        
        // ×‘×“×™×§×” ×× ×”× ×ª×•× ×™× ××•×¦×¤× ×™×
        try {
          JSON.parse(stored);
          // ×× ×”×¦×œ×™×— - ×œ× ××•×¦×¤×Ÿ
          return JSON.parse(stored);
        } catch (e) {
          // ×× × ×›×©×œ - ×× ×¡×” ×œ×¤×¢× ×—
          return decryptData(stored);
        }
      } catch (e) {
        console.error("×©×’×™××” ×‘×˜×¢×™× ×ª ×”× ×ª×•× ×™×:", e);
        return [];
      }
    }
    
    function saveReceiptsToStorage(receipts) {
      try {
        // ×”×¦×¤× ×ª ×”× ×ª×•× ×™× ×œ×¤× ×™ ×©××™×¨×”
        const encryptedData = encryptData(receipts);
        localStorage.setItem('mfix_receipts', encryptedData);
      } catch (e) {
        console.error("×©×’×™××” ×‘×©××™×¨×ª ×”× ×ª×•× ×™×:", e);
        // ×’×™×‘×•×™ - ×©××™×¨×” ×œ×œ× ×”×¦×¤× ×”
        localStorage.setItem('mfix_receipts', JSON.stringify(receipts));
      }
    }

    function generateReceiptHTML(data) {
      const deviceTypeText = {
        'smartphone': '×¡×××¨×˜×¤×•×Ÿ',
        'tablet': '×˜××‘×œ×˜',
        'laptop': '××—×©×‘ × ×™×™×“',
        'smartwatch': '×©×¢×•×Ÿ ×—×›×',
        'other': '××—×¨'
      };
      
      const estimatedTimeText = {
        '1-2': '1-2 ×™××™×',
        '3-5': '3-5 ×™××™×',
        '1week': '×¢×“ ×©×‘×•×¢',
        '2weeks': '×¢×“ ×©×‘×•×¢×™×™×',
        'unknown': '×œ× ×™×“×•×¢'
      };
      
      return `
        <h3>×˜×•×¤×¡ ×ª×™×§×•×Ÿ - Mfix</h3>
        <div class="doc-number">××¡' ×˜×•×¤×¡: ${data.docNumber}</div>
        <div class="doc-date">${data.timestamp}</div>
        
        <div class="receipt-grid">
          <div class="receipt-item">
            <strong>×©× ×œ×§×•×—:</strong> ${escapeHtml(data.customerName)}
          </div>
          <div class="receipt-item">
            <strong>×˜×œ×¤×•×Ÿ:</strong> ${escapeHtml(data.phone)}
          </div>
          ${data.email ? `<div class="receipt-item"><strong>××™××™×™×œ:</strong> ${escapeHtml(data.email)}</div>` : ''}
          <div class="receipt-item">
            <strong>×¡×•×’ ××›×©×™×¨:</strong> ${deviceTypeText[data.deviceType] || escapeHtml(data.deviceType)}
          </div>
          <div class="receipt-item">
            <strong>×“×’×:</strong> ${escapeHtml(data.deviceModel)}
          </div>
          ${data.estimatedTime ? `<div class="receipt-item"><strong>×–××Ÿ ××©×•×¢×¨:</strong> ${estimatedTimeText[data.estimatedTime] || escapeHtml(data.estimatedTime)}</div>` : ''}
        </div>
        
        <div class="receipt-item">
          <strong>×ª×™××•×¨ ×ª×§×œ×”:</strong><br>
          ${escapeHtml(data.issueDescription).replace(/\n/g, '<br>')}
        </div>
        
        ${data.devicePassword ? `<div class="receipt-item"><strong>×§×•×“/×¡×™×¡××”:</strong> ${escapeHtml(data.devicePassword)}</div>` : ''}
        
        <hr>
        
        <div class="receipt-grid">
          <div class="receipt-item">
            <strong>×¡×›×•× ×œ×œ× ××¢"×:</strong> ${data.netAmount.toFixed(2)} â‚ª
          </div>
          <div class="receipt-item">
            <strong>××¢"× (18%):</strong> ${data.vatAmount.toFixed(2)} â‚ª
          </div>
        </div>
        
        <div class="receipt-item" style="font-size: 16px; font-weight: bold; margin-top: 10px;">
          <strong>×¡×”"×› ×œ×ª×©×œ×•× (×›×•×œ×œ ××¢"×):</strong> ${data.totalAmount.toFixed(2)} â‚ª
        </div>
        
        <p class="footer-text">×ª×•×“×” ××¦×•×•×ª ×”×˜×›× ××™× - Mfix<br>×§× ×™×•×Ÿ ×¢×–×¨×™××œ×™ ×¨××œ×”</p>
      `;
    }

    function generateLabelHTML(data) {
      const deviceTypeText = {
        'smartphone': 'ğŸ“±',
        'tablet': 'ğŸ“Ÿ',
        'laptop': 'ğŸ’»',
        'smartwatch': 'âŒš',
        'other': 'ğŸ“²'
      };
      
      return `
        <h3>Mfix - ×ª×•×•×™×ª</h3>
        <div class="doc-number">#${data.docNumber}</div>
        <p><strong>${escapeHtml(data.customerName)}</strong></p>
        <p>${deviceTypeText[data.deviceType] || 'ğŸ“±'} ${escapeHtml(data.deviceModel)}</p>
        <p>ğŸ“ ${escapeHtml(data.phone)}</p>
        <p style="text-align:center; margin-top:8px; font-size:10px;">${new Date().toLocaleDateString('he-IL')}</p>
        <p class="footer-text" style="font-size:10px;">Mfix - ×§× ×™×•×Ÿ ×¢×–×¨×™××œ×™ ×¨××œ×”</p>
      `;
    }

    // === ×©××™×¨×” ××•×˜×•××˜×™×ª + ×”×¦×’×ª ×˜×•×¤×¡ ===
    function generateAndSaveForm() {
      const name = document.getElementById('customerName').value.trim();
      const phone = document.getElementById('phone').value.trim();
      const email = document.getElementById('email').value.trim();
      const deviceType = document.getElementById('deviceType').value;
      const model = document.getElementById('deviceModel').value.trim();
      const password = document.getElementById('devicePassword').value.trim();
      const estimatedTime = document.getElementById('estimatedTime').value;
      const totalStr = document.getElementById('totalAmount').value;
      const issue = document.getElementById('issueDescription').value.trim();

      if (!name || !phone || !deviceType || !model || !totalStr || !issue) {
        showNotification("× × ××œ× ××ª ×›×œ ×”×©×“×•×ª ×”×—×•×‘×”.", "error");
        return;
      }

      const total = parseFloat(totalStr);
      if (total <= 0) {
        showNotification("×¡×›×•× ×—×™×™×‘ ×œ×”×™×•×ª ×’×“×•×œ ×-0.", "error");
        return;
      }

      const net = (total / 1.18).toFixed(2);
      const vat = (total - net).toFixed(2);
      const now = new Date();
      const docNumber = getNextDocNumber();

      const receiptData = {
        id: Date.now(),
        docNumber: docNumber,
        timestamp: now.toLocaleString('he-IL', { hour12: false }),
        customerName: name,
        phone: phone,
        email: email,
        deviceType: deviceType,
        deviceModel: model,
        devicePassword: password,
        estimatedTime: estimatedTime,
        totalAmount: total,
        netAmount: parseFloat(net),
        vatAmount: parseFloat(vat),
        issueDescription: issue,
        completed: false
      };

      let receipts = getReceiptsFromStorage();
      receipts.push(receiptData);
      saveReceiptsToStorage(receipts);

      document.getElementById('receipt').innerHTML = generateReceiptHTML(receiptData);
      document.getElementById('receipt').style.display = 'block';
      document.getElementById('labelPreview').innerHTML = generateLabelHTML(receiptData);
      document.getElementById('labelPreview').style.display = 'none';
      
      // ×”×¦×’×ª ××¤×©×¨×•×™×•×ª ×”×”×“×¤×¡×”
      document.getElementById('printOptions').style.display = 'block';

      showNotification("×˜×•×¤×¡ × ×©××¨ ×‘×”×¦×œ×—×”!", "success");
      
      if (document.getElementById('saved-tab').classList.contains('active')) {
        loadAllReceipts();
      }
    }

    // === ×”×“×¤×¡×” ××©×•×›×œ×œ×ª ===
    function printReceipt() {
      if (document.getElementById('receipt').style.display !== 'block') {
        showNotification("××™×Ÿ ×˜×•×¤×¡ ×œ×”×“×¤×¡×”.", "error");
        return;
      }
      
      const receipt = document.getElementById('receipt');
      const originalStyles = {
        maxWidth: receipt.style.maxWidth,
        padding: receipt.style.padding,
        fontSize: receipt.style.fontSize
      };
      
      // ×”×ª×××ª ×”×¡×’× ×•×Ÿ ×œ×¡×•×’ ×”×”×“×¤×¡×”
      applyPrintStyles(receipt, currentPrintType);
      
      // ×”×“×¤×¡×”
      window.print();
      
      // ×©×—×–×•×¨ ×”×¡×’× ×•×Ÿ ×”××§×•×¨×™
      receipt.style.maxWidth = originalStyles.maxWidth;
      receipt.style.padding = originalStyles.padding;
      receipt.style.fontSize = originalStyles.fontSize;
      
      showNotification(`×”×˜×•×¤×¡ ×”×•×“×¤×¡ ×‘×”×¦×œ×—×” ×œ××“×¤×¡×ª ${getPrintTypeName(currentPrintType)}`, "success");
    }

    function printLabel() {
      const receipt = document.getElementById('receipt');
      if (receipt.style.display !== 'block') {
        showNotification("××™×Ÿ ×˜×•×¤×¡ ×›×“×™ ×œ×”×“×¤×™×¡ ×ª×•×•×™×ª.", "error");
        return;
      }
      
      const label = document.getElementById('labelPreview');
      const originalStyles = {
        maxWidth: label.style.maxWidth,
        padding: label.style.padding,
        fontSize: label.style.fontSize,
        display: label.style.display
      };
      
      // ×”×ª×××ª ×”×¡×’× ×•×Ÿ ×œ×¡×•×’ ×”×”×“×¤×¡×”
      applyPrintStyles(label, currentPrintType);
      label.style.display = 'block';
      
      // ×”×“×¤×¡×”
      window.print();
      
      // ×©×—×–×•×¨ ×”×¡×’× ×•×Ÿ ×”××§×•×¨×™
      label.style.maxWidth = originalStyles.maxWidth;
      label.style.padding = originalStyles.padding;
      label.style.fontSize = originalStyles.fontSize;
      label.style.display = originalStyles.display;
      
      showNotification(`×”×ª×•×•×™×ª ×”×•×“×¤×¡×” ×‘×”×¦×œ×—×” ×œ××“×¤×¡×ª ${getPrintTypeName(currentPrintType)}`, "success");
    }

    // === ×™×¦×•× ===
    async function exportToPDF() {
      const receipt = document.getElementById('receipt');
      if (receipt.style.display !== 'block') {
        showNotification("××™×Ÿ ×˜×•×¤×¡ ×œ×™×¦×•×.", "error");
        return;
      }
      
      showLoading(true);
      try {
        const canvas = await html2canvas(receipt, { scale: 2, backgroundColor: '#ffffff' });
        const { jsPDF } = window.jspdf;
        const imgWidth = 180;
        const imgHeight = (canvas.height * imgWidth) / canvas.width;
        const pdf = new jsPDF({ unit: 'mm', format: 'a4' });
        pdf.addImage(canvas.toDataURL('image/png'), 'PNG', 15, 15, imgWidth, imgHeight);
        pdf.save(`×˜×•×¤×¡_×ª×™×§×•×Ÿ_${document.querySelector('.doc-number').innerText.split(': ')[1]}.pdf`);
        showNotification("PDF × ×•×¦×¨ ×•×”×•×¨×“ ×‘×”×¦×œ×—×”", "success");
      } catch (e) {
        console.error(e);
        showNotification("×©×’×™××” ×‘×™×¦×™×¨×ª PDF", "error");
      } finally {
        showLoading(false);
      }
    }

    async function downloadReceiptImage() {
      const receipt = document.getElementById('receipt');
      if (receipt.style.display !== 'block') {
        showNotification("××™×Ÿ ×˜×•×¤×¡ ×œ×”×•×¨×“×”.", "error");
        return;
      }
      
      showLoading(true);
      try {
        const canvas = await html2canvas(receipt, { scale: 2, backgroundColor: '#ffffff' });
        const link = document.createElement('a');
        link.download = `×˜×•×¤×¡_×ª×™×§×•×Ÿ_${document.querySelector('.doc-number').innerText.split(': ')[1]}.png`;
        link.href = canvas.toDataURL('image/png');
        link.click();
        showNotification("×ª××•× ×” ×”×•×¨×“×” ×‘×”×¦×œ×—×”", "success");
      } catch (e) {
        console.error(e);
        showNotification("×©×’×™××” ×‘×”×•×¨×“×ª ×ª××•× ×”", "error");
      } finally {
        showLoading(false);
      }
    }

    // === ×©×œ×™×—×” ×œ×•×•××˜×¡××¤ ===
    function sendToWhatsApp() {
      const name = document.getElementById('customerName').value.trim();
      const phoneInput = document.getElementById('phone').value.trim();
      const model = document.getElementById('deviceModel').value.trim();
      const total = parseFloat(document.getElementById('totalAmount').value) || 0;
      const issue = document.getElementById('issueDescription').value.trim();
      const docNum = document.querySelector('.doc-number')?.innerText.split(': ')[1] || 'N/A';

      if (!name || !phoneInput || !model || total <= 0 || !issue) {
        showNotification("× × ××œ× ××ª ×›×œ ×”×©×“×•×ª ×”×—×•×‘×”.", "error");
        return;
      }

      const phone = formatIsraeliPhone(phoneInput);
      if (!phone || phone.length < 10) {
        showNotification("××¡×¤×¨ ×˜×œ×¤×•×Ÿ ×œ× ×ª×§×™×Ÿ. × × ×”×–×Ÿ ××¡×¤×¨ ×¢× 05X.", "error");
        return;
      }

      const net = (total / 1.18).toFixed(2);
      const vat = (total - net).toFixed(2);
      const message = 
        `×©×œ×•× ${encodeURIComponent(name)}!%0A%0A` +
        `×˜×•×¤×¡ ×ª×™×§×•×Ÿ ××¡×¤×¨: ${docNum}%0A` +
        `×“×’×: ${encodeURIComponent(model)}%0A` +
        `×ª×™××•×¨ ×ª×§×œ×”: ${encodeURIComponent(issue)}%0A%0A` +
        `×¡×›×•× ×œ×œ× ××¢"×: ${net} â‚ª%0A` +
        `××¢"× (18%): ${vat} â‚ª%0A` +
        `×¡×”"×› ×œ×ª×©×œ×•× (×›×•×œ×œ ××¢"×): ${total.toFixed(2)} â‚ª%0A%0A` +
        `×ª×•×“×” ××¦×•×•×ª ×”×˜×›× ××™× - Mfix` +
        `%0A×§× ×™×•×Ÿ ×¢×–×¨×™××œ×™ ×¨××œ×”`;

      window.open(`https://wa.me/${phone}?text=${message}`, '_blank');
    }

    function sendEmail() {
      const name = document.getElementById('customerName').value.trim();
      const phone = document.getElementById('phone').value.trim();
      const email = document.getElementById('email').value.trim();
      const model = document.getElementById('deviceModel').value.trim();
      const total = parseFloat(document.getElementById('totalAmount').value) || 0;
      const issue = document.getElementById('issueDescription').value.trim();
      const docNum = document.querySelector('.doc-number')?.innerText.split(': ')[1] || 'N/A';

      if (!name || !phone || !model || total <= 0 || !issue) {
        showNotification("× × ××œ× ××ª ×›×œ ×”×©×“×•×ª ×”×—×•×‘×”.", "error");
        return;
      }

      const net = (total / 1.18).toFixed(2);
      const vat = (total - net).toFixed(2);
      const subject = `×˜×•×¤×¡ ×ª×™×§×•×Ÿ ××¡×¤×¨ ${docNum} - Mfix`;
      const body = 
        `×©×œ×•× ${name}!\n\n` +
        `×˜×•×¤×¡ ×ª×™×§×•×Ÿ ××¡×¤×¨: ${docNum}\n` +
        `×“×’×: ${model}\n` +
        `×ª×™××•×¨ ×ª×§×œ×”: ${issue}\n\n` +
        `×¡×›×•× ×œ×œ× ××¢"×: ${net} â‚ª\n` +
        `××¢"× (18%): ${vat} â‚ª\n` +
        `×¡×”"×› ×œ×ª×©×œ×•× (×›×•×œ×œ ××¢"×): ${total.toFixed(2)} â‚ª\n\n` +
        `×ª×•×“×” ××¦×•×•×ª ×”×˜×›× ××™× - Mfix\n` +
        `×§× ×™×•×Ÿ ×¢×–×¨×™××œ×™ ×¨××œ×”`;

      window.location.href = `mailto:${email || ''}?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;
    }

    // === ×©××™×¨×” ×•×—×™×¤×•×© ===
    function renderReceiptList(receipts, containerId) {
      const container = document.getElementById(containerId);
      if (receipts.length === 0) {
        container.innerHTML = '<p style="text-align:center; color:#7f8c8d;">××™×Ÿ ××¡××›×™× ×©××•×¨×™×.</p>';
        return;
      }

      let html = '';
      receipts.forEach(r => {
        const statusBadge = r.completed ? 
          '<span class="status-badge status-completed">ğŸŸ¢ ×”×•×©×œ×</span>' : 
          '<span class="status-badge" style="background:#fff3cd; color:#856404;">ğŸŸ¡ ×‘×ª×”×œ×™×š</span>';

        html += `
          <div class="saved-item">
            <div class="item-header">
              <span>${statusBadge}×˜×•×¤×¡ #${r.docNumber} - ${r.customerName}</span>
              <span>${r.totalAmount.toFixed(2)} â‚ª</span>
            </div>
            <div class="item-meta">
              ğŸ“ ${r.phone} | ${r.deviceModel} | ${r.timestamp}
            </div>
            <div class="item-actions">
              <button class="btn-success" onclick="viewSavedReceipt(${r.id})">
                <i class="fas fa-eye"></i> ×¦×¤×”
              </button>
              <button class="btn-print" onclick="printSavedReceipt(${r.id})">
                <i class="fas fa-print"></i> ×”×“×¤×¡
              </button>
              <button class="btn-label" onclick="printLabelFromId(${r.id})">
                <i class="fas fa-tag"></i> ×ª×•×•×™×ª
              </button>
              <button class="btn-whatsapp" onclick="whatsappSavedReceipt(${r.id})">
                <i class="fab fa-whatsapp"></i> ×©×œ×—
              </button>
              <button class="btn-email" onclick="emailSavedReceipt(${r.id})">
                <i class="fas fa-envelope"></i> ×“×•×"×œ
              </button>
              ${!r.completed ? 
                `<button class="btn-complete" onclick="markAsCompleted(${r.id})">
                  <i class="fas fa-check"></i> ×ª×™×§×•×Ÿ ×”×•×©×œ×
                </button>` : ''}
              <button class="btn-danger" onclick="deleteReceipt(${r.id})">
                <i class="fas fa-trash"></i> ××—×§
              </button>
            </div>
          </div>
        `;
      });
      container.innerHTML = html;
    }

    function loadAllReceipts() {
      const receipts = getReceiptsFromStorage();
      renderReceiptList(receipts, 'savedList');
    }

    function searchReceipts() {
      const nameQuery = document.getElementById('searchByName').value.trim().toLowerCase();
      const phoneQuery = document.getElementById('searchByPhone').value.trim().replace(/\D/g, '');
      const deviceQuery = document.getElementById('searchByDevice').value.trim().toLowerCase();
      let receipts = getReceiptsFromStorage();

      const filtered = receipts.filter(r => {
        const matchName = nameQuery ? r.customerName.toLowerCase().includes(nameQuery) : true;
        const matchPhone = phoneQuery ? r.phone.replace(/\D/g, '').includes(phoneQuery) : true;
        const matchDevice = deviceQuery ? r.deviceModel.toLowerCase().includes(deviceQuery) : true;
        return matchName && matchPhone && matchDevice;
      });

      renderReceiptList(filtered, 'searchResults');
    }
    
    function deleteReceipt(id) {
      if (!confirm("×”×× ××ª×” ×‘×˜×•×— ×©×‘×¨×¦×•× ×š ×œ××—×•×§ ×˜×•×¤×¡ ×–×”?")) return;
      
      let receipts = getReceiptsFromStorage();
      receipts = receipts.filter(r => r.id != id);
      saveReceiptsToStorage(receipts);
      showNotification("×˜×•×¤×¡ × ××—×§ ×‘×”×¦×œ×—×”", "success");
      loadAllReceipts();
    }

    // === ×™×™×¦×•× ××¡××›×™× ===
    function exportAllReceipts() {
      const receipts = getReceiptsFromStorage();
      if (receipts.length === 0) {
        showNotification("××™×Ÿ ××¡××›×™× ×œ×©××™×¨×”.", "error");
        return;
      }

      const jsonString = JSON.stringify(receipts, null, 2);
      const blob = new Blob([jsonString], { type: 'application/json;charset=utf-8;' });
      const url = URL.createObjectURL(blob);
      
      const link = document.createElement('a');
      link.href = url;
      link.setAttribute('download', 'Mfix_×›×œ_×”××¡××›×™×.json');
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
      URL.revokeObjectURL(url);
      showNotification("×›×œ ×”××¡××›×™× ×™×•×¦××• ×‘×”×¦×œ×—×”", "success");
    }

    function importReceipts(event) {
      const file = event.target.files[0];
      if (!file) return;

      const reader = new FileReader();
      reader.onload = function(e) {
        try {
          const imported = JSON.parse(e.target.result);
          if (!Array.isArray(imported)) throw new Error("×¤×•×¨××˜ ×œ× ×ª×§×™×Ÿ");

          let receipts = getReceiptsFromStorage();
          const existingMax = receipts.length > 0 ? Math.max(...receipts.map(r => r.docNumber || 0)) : 1344;
          let nextNum = existingMax + 1;

          const validReceipts = imported.filter(r => 
            r.customerName && r.phone && r.deviceModel && r.totalAmount !== undefined
          ).map(r => {
            if (!r.docNumber || receipts.some(ex => ex.docNumber === r.docNumber)) {
              r.docNumber = nextNum++;
            }
            r.id = r.id || Date.now() + Math.random();
            if (r.completed === undefined) r.completed = false;
            // ×”×•×¡×¤×ª ×©×“×•×ª ×—×¡×¨×™× ×× ×¦×¨×™×š
            if (!r.deviceType) r.deviceType = 'other';
            if (!r.estimatedTime) r.estimatedTime = '';
            if (!r.email) r.email = '';
            return r;
          });

          if (validReceipts.length === 0) {
            showNotification("×œ× × ××¦××• ××¡××›×™× ×ª×§×™× ×™× ×‘×§×•×‘×¥.", "error");
            return;
          }

          receipts = [...receipts, ...validReceipts];
          saveReceiptsToStorage(receipts);
          showNotification(`×™×•×‘××• ×‘×”×¦×œ×—×” ${validReceipts.length} ××¡××›×™×.`, "success");
          loadAllReceipts();
        } catch (err) {
          console.error(err);
          showNotification("×©×’×™××” ×‘×™×‘×•× ×”×§×•×‘×¥. ×•×“× ×©×–×” ×§×•×‘×¥ JSON ×ª×§×™×Ÿ.", "error");
        }
      };
      reader.readAsText(file);
      event.target.value = '';
    }

    // === ×¤×¢×•×œ×•×ª ×¢×œ ××¡××š ×©××•×¨ ===
    function getReceiptById(id) {
      const receipts = getReceiptsFromStorage();
      return receipts.find(r => r.id == id);
    }

    function viewSavedReceipt(id) {
      const receipt = getReceiptById(id);
      if (!receipt) {
        showNotification("××¡××š ×œ× × ××¦×.", "error");
        return;
      }
      
      document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
      document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
      document.querySelector('.tab-btn[data-tab="form"]').classList.add('active');
      document.getElementById('form-tab').classList.add('active');
      
      document.getElementById('receipt').innerHTML = generateReceiptHTML(receipt);
      document.getElementById('receipt').style.display = 'block';
      document.getElementById('labelPreview').innerHTML = generateLabelHTML(receipt);
      
      // ×”×¦×’×ª ××¤×©×¨×•×™×•×ª ×”×”×“×¤×¡×”
      document.getElementById('printOptions').style.display = 'block';
    }

    function printSavedReceipt(id) {
      viewSavedReceipt(id);
      setTimeout(() => printReceipt(), 100);
    }

    function printLabelFromId(id) {
      viewSavedReceipt(id);
      setTimeout(() => printLabel(), 100);
    }

    function whatsappSavedReceipt(id) {
      const r = getReceiptById(id);
      if (!r) {
        showNotification("××¡××š ×œ× × ××¦×.", "error");
        return;
      }

      const phoneClean = formatIsraeliPhone(r.phone);
      if (!phoneClean || phoneClean.length < 10) {
        showNotification("××¡×¤×¨ ×˜×œ×¤×•×Ÿ ×œ× ×ª×§×™×Ÿ ×‘××¡××š ×–×”.", "error");
        return;
      }

      const net = r.netAmount.toFixed(2);
      const vat = r.vatAmount.toFixed(2);
      const message = 
        `×©×œ×•× ${encodeURIComponent(r.customerName)}!%0A%0A` +
        `×˜×•×¤×¡ ×ª×™×§×•×Ÿ ××¡×¤×¨: ${r.docNumber}%0A` +
        `×“×’×: ${encodeURIComponent(r.deviceModel)}%0A` +
        `×ª×™××•×¨ ×ª×§×œ×”: ${encodeURIComponent(r.issueDescription)}%0A%0A` +
        `×¡×›×•× ×œ×œ× ××¢"×: ${net} â‚ª%0A` +
        `××¢"× (18%): ${vat} â‚ª%0A` +
        `×¡×”"×› ×œ×ª×©×œ×•× (×›×•×œ×œ ××¢"×): ${r.totalAmount.toFixed(2)} â‚ª%0A%0A` +
        `×ª×•×“×” ××¦×•×•×ª ×”×˜×›× ××™× - Mfix` +
        `%0A×§× ×™×•×Ÿ ×¢×–×¨×™××œ×™ ×¨××œ×”`;

      window.open(`https://wa.me/${phoneClean}?text=${message}`, '_blank');
    }

    function emailSavedReceipt(id) {
      const r = getReceiptById(id);
      if (!r) {
        showNotification("××¡××š ×œ× × ××¦×.", "error");
        return;
      }

      const net = r.netAmount.toFixed(2);
      const vat = r.vatAmount.toFixed(2);
      const subject = `×˜×•×¤×¡ ×ª×™×§×•×Ÿ ××¡×¤×¨ ${r.docNumber} - Mfix`;
      const body = 
        `×©×œ×•× ${r.customerName}!\n\n` +
        `×˜×•×¤×¡ ×ª×™×§×•×Ÿ ××¡×¤×¨: ${r.docNumber}\n` +
        `×“×’×: ${r.deviceModel}\n` +
        `×ª×™××•×¨ ×ª×§×œ×”: ${r.issueDescription}\n\n` +
        `×¡×›×•× ×œ×œ× ××¢"×: ${net} â‚ª\n` +
        `××¢"× (18%): ${vat} â‚ª\n` +
        `×¡×”"×› ×œ×ª×©×œ×•× (×›×•×œ×œ ××¢"×): ${r.totalAmount.toFixed(2)} â‚ª\n\n` +
        `×ª×•×“×” ××¦×•×•×ª ×”×˜×›× ××™× - Mfix\n` +
        `×§× ×™×•×Ÿ ×¢×–×¨×™××œ×™ ×¨××œ×”`;

      window.location.href = `mailto:${r.email || ''}?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;
    }

    // === ×¡×™××•×Ÿ ×›"×”×•×©×œ×" ===
    function markAsCompleted(id) {
      if (!confirm("×œ×¡××Ÿ ××ª ×”×˜×•×¤×¡ ×”×–×” ×›'×ª×™×§×•×Ÿ ×”×•×©×œ×'?")) return;

      let receipts = getReceiptsFromStorage();
      const index = receipts.findIndex(r => r.id == id);
      if (index === -1) {
        showNotification("××¡××š ×œ× × ××¦×.", "error");
        return;
      }

      receipts[index].completed = true;
      saveReceiptsToStorage(receipts);
      showNotification("×˜×•×¤×¡ ×¡×•××Ÿ ×›×”×•×©×œ×!", "success");
      loadAllReceipts();
    }

    // === ×˜××‘ "×ª×™×§×•×Ÿ ×”×•×©×œ×" ===
    function loadCompletionDropdown() {
      const select = document.getElementById('completeDocId');
      select.innerHTML = '<option value="">×‘×—×¨ ××¡××š...</option>';
      const receipts = getReceiptsFromStorage();
      receipts.filter(r => !r.completed).forEach(r => {
        const option = document.createElement('option');
        option.value = r.id;
        option.textContent = `#${r.docNumber} - ${r.customerName} (${r.deviceModel})`;
        select.appendChild(option);
      });
    }

    function sendCompletionWhatsApp() {
      const id = document.getElementById('completeDocId').value;
      if (!id) {
        showNotification("×× × ×‘×—×¨ ××¡××š.", "error");
        return;
      }
      const r = getReceiptById(id);
      if (!r) {
        showNotification("××¡××š ×œ× × ××¦×.", "error");
        return;
      }

      const phoneClean = formatIsraeliPhone(r.phone);
      if (!phoneClean || phoneClean.length < 10) {
        showNotification("××¡×¤×¨ ×˜×œ×¤×•×Ÿ ×œ× ×ª×§×™×Ÿ ×‘××¡××š ×–×”.", "error");
        return;
      }

      const deviceModel = r.deviceModel || "×œ× ×¦×•×™×Ÿ";

      const message = 
        `××™×–×” ×›×™×£ğŸ‘!%0A%0A` +
        `×”××›×©×™×¨ ×©××¡×¨×ª× ×œ×ª×™×§×•×Ÿ, ×ª×•×§×Ÿ ×•×××ª×™×Ÿ ×œ××™×¡×•×£.%0A%0A` +
        `${encodeURIComponent(deviceModel)}%0A%0A` +
        `×ª×•×“×” ××¦×•×•×ª ×”×˜×›× ××™× - Mfix%0A` +
        `×§× ×™×•×Ÿ ×¢×–×¨×™××œ×™ ×¨××œ×”`;

      markAsCompletedSilent(id);
      window.open(`https://wa.me/${phoneClean}?text=${message}`, '_blank');
    }

    function sendCompletionEmail() {
      const id = document.getElementById('completeDocId').value;
      if (!id) {
        showNotification("×× × ×‘×—×¨ ××¡××š.", "error");
        return;
      }
      const r = getReceiptById(id);
      if (!r) {
        showNotification("××¡××š ×œ× × ××¦×.", "error");
        return;
      }

      const deviceModel = r.deviceModel || "×œ× ×¦×•×™×Ÿ";

      const subject = `×”××›×©×™×¨ ×©×œ×š ××•×›×Ÿ ×œ××™×¡×•×£ - Mfix`;
      const body = 
        `××™×–×” ×›×™×£! ğŸ‘\n\n` +
        `×”××›×©×™×¨ ×©××¡×¨×ª× ×œ×ª×™×§×•×Ÿ, ×ª×•×§×Ÿ ×•×××ª×™×Ÿ ×œ××™×¡×•×£.\n\n` +
        `${deviceModel}\n\n` +
        `×ª×•×“×” ××¦×•×•×ª ×”×˜×›× ××™× - Mfix\n` +
        `×§× ×™×•×Ÿ ×¢×–×¨×™××œ×™ ×¨××œ×”`;

      markAsCompletedSilent(id);
      window.location.href = `mailto:${r.email || ''}?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;
    }

    function sendCompletionSMS() {
      const id = document.getElementById('completeDocId').value;
      if (!id) {
        showNotification("×× × ×‘×—×¨ ××¡××š.", "error");
        return;
      }
      const r = getReceiptById(id);
      if (!r) {
        showNotification("××¡××š ×œ× × ××¦×.", "error");
        return;
      }

      const phoneClean = formatIsraeliPhone(r.phone);
      if (!phoneClean || phoneClean.length < 10) {
        showNotification("××¡×¤×¨ ×˜×œ×¤×•×Ÿ ×œ× ×ª×§×™×Ÿ ×‘××¡××š ×–×”.", "error");
        return;
      }

      const deviceModel = r.deviceModel || "×œ× ×¦×•×™×Ÿ";

      const message = 
        `××™×–×” ×›×™×£! ×”××›×©×™×¨ ×©××¡×¨×ª× ×œ×ª×™×§×•×Ÿ, ×ª×•×§×Ÿ ×•×××ª×™×Ÿ ×œ××™×¡×•×£.\n\n${deviceModel}\n\n×ª×•×“×” ××¦×•×•×ª ×”×˜×›× ××™× - Mfix, ×§× ×™×•×Ÿ ×¢×–×¨×™××œ×™ ×¨××œ×”.`;

      markAsCompletedSilent(id);
      window.location.href = `sms:${phoneClean}?body=${encodeURIComponent(message)}`;
    }

    function markAsCompletedSilent(id) {
      let receipts = getReceiptsFromStorage();
      const index = receipts.findIndex(r => r.id == id);
      if (index !== -1) {
        receipts[index].completed = true;
        saveReceiptsToStorage(receipts);
        loadCompletionDropdown();
      }
    }
    
    // ×˜×¢×™× ×” ×¨××©×•× ×™×ª
    document.addEventListener('DOMContentLoaded', function() {
      loadAllReceipts();
      initBackupSystem();
    });
  </script>

  <!-- ×§×•×“ ×”×©×™×¤×•×¨×™× ×”××ª×§×“× -->
  <script>
    // ğŸ“„ ×§×•×“ ×”×©×™×¤×•×¨×™× ×”××ª×§×“× - Mfix Enhancements
    // ×§×•×‘×¥ ×–×” ××•×¡×™×£ ×©×™×¤×•×¨×™× ××ª×§×“××™× ×œ×œ× ×©×™× ×•×™ ×‘×§×•×“ ×”××§×•×¨×™

    // ğŸš€ CONFIGURATION AND CONSTANTS
    const MfixConfig = {
        VAT_RATE: 0.18,
        BACKUP_INTERVAL: 10 * 60 * 1000,
        MAX_BACKUPS: 50,
        SEARCH_DEBOUNCE: 300,
        TOUCH_MIN_HEIGHT: '44px',
        
        PRINT_TYPES: {
            '58mm': { width: '58mm', padding: '5px', fontSize: '9px' },
            '80mm': { width: '80mm', padding: '8px', fontSize: '10px' },
            'a4': { width: '100%', padding: '20px', fontSize: '14px' }
        },
        
        DEVICE_TYPES: {
            'smartphone': '×¡×××¨×˜×¤×•×Ÿ',
            'tablet': '×˜××‘×œ×˜', 
            'laptop': '××—×©×‘ × ×™×™×“',
            'smartwatch': '×©×¢×•×Ÿ ×—×›×',
            'other': '××—×¨'
        },
        
        MESSAGE_TEMPLATES: {
            completion: {
                whatsapp: "××™×–×” ×›×™×£ğŸ‘!%0A%0A×”××›×©×™×¨ ×©××¡×¨×ª× ×œ×ª×™×§×•×Ÿ, ×ª×•×§×Ÿ ×•×××ª×™×Ÿ ×œ××™×¡×•×£.%0A%0A{deviceModel}%0A%0A×ª×•×“×” ××¦×•×•×ª ×”×˜×›× ××™× - Mfix%0A×§× ×™×•×Ÿ ×¢×–×¨×™××œ×™ ×¨××œ×”",
                email: "××™×–×” ×›×™×£! ğŸ‘\n\n×”××›×©×™×¨ ×©××¡×¨×ª× ×œ×ª×™×§×•×Ÿ, ×ª×•×§×Ÿ ×•×××ª×™×Ÿ ×œ××™×¡×•×£.\n\n{deviceModel}\n\n×ª×•×“×” ××¦×•×•×ª ×”×˜×›× ××™× - Mfix\n×§× ×™×•×Ÿ ×¢×–×¨×™××œ×™ ×¨××œ×”",
                sms: "××™×–×” ×›×™×£! ×”××›×©×™×¨ ×©××¡×¨×ª× ×œ×ª×™×§×•×Ÿ, ×ª×•×§×Ÿ ×•×××ª×™×Ÿ ×œ××™×¡×•×£.\n\n{deviceModel}\n\n×ª×•×“×” ××¦×•×•×ª ×”×˜×›× ××™× - Mfix, ×§× ×™×•×Ÿ ×¢×–×¨×™××œ×™ ×¨××œ×”."
            },
            reminder: {
                whatsapp: "×ª×–×›×•×¨×ª - ×”××›×©×™×¨ {deviceModel} ×¢×“×™×™×Ÿ ××¦×œ× ×• ×œ×ª×™×§×•×Ÿ.%0A× ×•×¢×“× ×• ×œ×¢×“×›×Ÿ ×‘×”××©×š.%0A%0AMfix - ×§× ×™×•×Ÿ ×¢×–×¨×™××œ×™ ×¨××œ×”",
                email: "×ª×–×›×•×¨×ª ×‘× ×•×’×¢ ×œ××›×©×™×¨ {deviceModel}\n\n×”××›×©×™×¨ ×¢×“×™×™×Ÿ ×‘×ª×”×œ×™×š ×ª×™×§×•×Ÿ, × ×¢×“×›×Ÿ ×‘×”××©×š.\n\n×¦×•×•×ª Mfix"
            }
        }
    };

    // âš¡ PERFORMANCE ENHANCEMENTS
    class PerformanceManager {
        constructor() {
            this.debounceTimers = new Map();
        }

        debounce(key, func, delay = MfixConfig.SEARCH_DEBOUNCE) {
            clearTimeout(this.debounceTimers.get(key));
            this.debounceTimers.set(key, setTimeout(func, delay));
        }

        static progressiveLoad(items, container, renderFunction, chunkSize = 10) {
            let index = 0;
            
            const loadChunk = () => {
                const chunk = items.slice(index, index + chunkSize);
                chunk.forEach(item => {
                    container.appendChild(renderFunction(item));
                });
                index += chunkSize;
                
                if (index < items.length) {
                    setTimeout(loadChunk, 0);
                }
            };
            
            loadChunk();
        }
    }

    // ğŸ¯ ERROR HANDLING AND VALIDATION
    class ValidationManager {
        static validateFormData(formData) {
            const errors = [];
            
            // Phone validation - Israeli format
            const phoneRegex = /^0(5[0-9]|7[0-9]|8[0-9])[0-9]{7}$/;
            const cleanPhone = formData.phone.replace(/\D/g, '');
            if (!phoneRegex.test(cleanPhone)) {
                errors.push('××¡×¤×¨ ×˜×œ×¤×•×Ÿ ×œ× ×ª×§×™×Ÿ. ×™×© ×œ×”×–×™×Ÿ ××¡×¤×¨ ×™×©×¨××œ×™ ×ª×§×™×Ÿ (05X-XXX-XXXX)');
            }
            
            // Email validation
            if (formData.email && !/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(formData.email)) {
                errors.push('×›×ª×•×‘×ª ××™××™×™×œ ×œ× ×ª×§×™× ×”');
            }
            
            // Amount validation
            if (formData.totalAmount <= 0) {
                errors.push('×¡×›×•× ×—×™×™×‘ ×œ×”×™×•×ª ×’×“×•×œ ×-0');
            }
            
            // Required fields
            const required = ['customerName', 'deviceType', 'deviceModel', 'issueDescription'];
            required.forEach(field => {
                if (!formData[field] || formData[field].trim() === '') {
                    errors.push(`×©×“×” ${this.getFieldName(field)} ×”×™× ×• ×—×•×‘×”`);
                }
            });
            
            return errors;
        }

        static getFieldName(field) {
            const names = {
                'customerName': '×©× ×œ×§×•×—',
                'deviceType': '×¡×•×’ ××›×©×™×¨',
                'deviceModel': '×“×’× ××›×©×™×¨',
                'issueDescription': '×ª×™××•×¨ ×ª×§×œ×”'
            };
            return names[field] || field;
        }
    }

    class ErrorHandler {
        static async safeOperation(operation, errorMessage, fallback = null) {
            try {
                const result = await operation();
                return result;
            } catch (error) {
                console.error(`${errorMessage}:`, error);
                
                if (typeof showNotification === 'function') {
                    showNotification(errorMessage, 'error');
                } else {
                    alert(errorMessage);
                }
                
                return fallback;
            }
        }

        static setupGlobalErrorHandling() {
            window.addEventListener('error', (event) => {
                console.error('Global error:', event.error);
                this.logError(event.error);
            });

            window.addEventListener('unhandledrejection', (event) => {
                console.error('Unhandled promise rejection:', event.reason);
                this.logError(event.reason);
            });
        }

        static logError(error) {
            const errorLog = {
                timestamp: new Date().toISOString(),
                message: error.message,
                stack: error.stack,
                userAgent: navigator.userAgent
            };
            
            const errors = JSON.parse(localStorage.getItem('mfix_errors') || '[]');
            errors.push(errorLog);
            localStorage.setItem('mfix_errors', JSON.stringify(errors.slice(-50)));
        }
    }

    // ğŸ“± ADVANCED UX ENHANCEMENTS
    class UXEnhancements {
        static init() {
            this.addProgressIndicators();
            this.enhanceMobileTouch();
            this.addKeyboardShortcuts();
            this.setupOfflineDetection();
        }

        static addProgressIndicators() {
            // CSS already added in style section
        }

        static showProgress(message, progress = 0) {
            let overlay = document.getElementById('progress-overlay');
            
            if (!overlay) {
                overlay = document.createElement('div');
                overlay.id = 'progress-overlay';
                overlay.className = 'progress-overlay';
                overlay.innerHTML = `
                    <div class="progress-container">
                        <div class="progress-message">${message}</div>
                        <div class="progress-bar">
                            <div class="progress-fill" style="width: ${progress}%"></div>
                        </div>
                    </div>
                `;
                document.body.appendChild(overlay);
            } else {
                overlay.querySelector('.progress-message').textContent = message;
                overlay.querySelector('.progress-fill').style.width = progress + '%';
            }
            
            return overlay;
        }

        static hideProgress() {
            const overlay = document.getElementById('progress-overlay');
            if (overlay) {
                overlay.remove();
            }
        }

        static enhanceMobileTouch() {
            const touchElements = document.querySelectorAll('button, .tab-btn, .saved-item, .result-item');
            touchElements.forEach(el => {
                el.classList.add('touch-optimized');
            });

            document.addEventListener('touchstart', function() {}, { passive: true });
        }

        static addKeyboardShortcuts() {
            document.addEventListener('keydown', (e) => {
                if ((e.ctrlKey || e.metaKey) && e.key === 's') {
                    e.preventDefault();
                    if (typeof generateAndSaveForm === 'function') {
                        generateAndSaveForm();
                    }
                }
                
                if ((e.ctrlKey || e.metaKey) && e.key === 'f') {
                    e.preventDefault();
                    const searchInput = document.getElementById('searchByName');
                    if (searchInput) {
                        searchInput.focus();
                    }
                }
                
                if (e.key === 'Escape') {
                    this.hideProgress();
                }
            });
        }

        static setupOfflineDetection() {
            const showOfflineBanner = () => {
                let banner = document.getElementById('offline-banner');
                if (!banner) {
                    banner = document.createElement('div');
                    banner.id = 'offline-banner';
                    banner.className = 'offline-banner';
                    banner.textContent = 'ğŸ”´ ××ª×” ×‘××¦×‘ ×œ× ××§×•×•×Ÿ';
                    document.body.appendChild(banner);
                }
            };

            const hideOfflineBanner = () => {
                const banner = document.getElementById('offline-banner');
                if (banner) {
                    banner.remove();
                }
            };

            window.addEventListener('online', () => {
                hideOfflineBanner();
                if (typeof showNotification === 'function') {
                    showNotification('×—×™×‘×•×¨ ×œ××™× ×˜×¨× ×˜ ×©×•×—×–×¨', 'success');
                }
            });

            window.addEventListener('offline', () => {
                showOfflineBanner();
                if (typeof showNotification === 'function') {
                    showNotification('××ª×” ×‘××¦×‘ ×œ× ××§×•×•×Ÿ', 'warning');
                }
            });

            if (!navigator.onLine) {
                showOfflineBanner();
            }
        }
    }

    // ğŸ”§ ADVANCED SEARCH AND FILTERS
    class AdvancedSearch {
        constructor() {
            this.filters = {
                dateRange: { from: '', to: '' },
                minAmount: 0,
                maxAmount: 10000,
                deviceTypes: [],
                status: 'all',
                searchText: ''
            };
            
            this.performanceManager = new PerformanceManager();
        }

        applyFilters() {
            this.filters = {
                dateRange: {
                    from: document.getElementById('searchDateFrom')?.value || '',
                    to: document.getElementById('searchDateTo')?.value || ''
                },
                minAmount: parseFloat(document.getElementById('searchMinAmount')?.value) || 0,
                maxAmount: parseFloat(document.getElementById('searchMaxAmount')?.value) || 10000,
                deviceTypes: Array.from(document.querySelectorAll('.device-type-checkbox:checked'))
                                .map(cb => cb.value),
                status: document.getElementById('searchStatus')?.value || 'all',
                searchText: document.getElementById('searchByName')?.value || ''
            };

            this.performAdvancedSearch();
        }

        performAdvancedSearch() {
            this.performanceManager.debounce('advancedSearch', () => {
                const receipts = this.getReceiptsFromStorage();
                const filtered = receipts.filter(receipt => this.matchesFilters(receipt));
                
                if (typeof renderReceiptList === 'function') {
                    renderReceiptList(filtered, 'searchResults');
                }
            }, MfixConfig.SEARCH_DEBOUNCE);
        }

        matchesFilters(receipt) {
            // Date range filter
            if (this.filters.dateRange.from || this.filters.dateRange.to) {
                const receiptDate = new Date(receipt.timestamp);
                if (this.filters.dateRange.from && receiptDate < new Date(this.filters.dateRange.from)) {
                    return false;
                }
                if (this.filters.dateRange.to && receiptDate > new Date(this.filters.dateRange.to + 'T23:59:59')) {
                    return false;
                }
            }

            // Amount range filter
            if (receipt.totalAmount < this.filters.minAmount || receipt.totalAmount > this.filters.maxAmount) {
                return false;
            }

            // Device type filter
            if (this.filters.deviceTypes.length > 0 && !this.filters.deviceTypes.includes(receipt.deviceType)) {
                return false;
            }

            // Status filter
            if (this.filters.status !== 'all') {
                const isCompleted = receipt.completed === true;
                if (this.filters.status === 'completed' && !isCompleted) return false;
                if (this.filters.status === 'pending' && isCompleted) return false;
            }

            // Text search
            if (this.filters.searchText) {
                const searchTerm = this.filters.searchText.toLowerCase();
                const searchableFields = [
                    receipt.customerName,
                    receipt.phone,
                    receipt.deviceModel,
                    receipt.issueDescription
                ];
                
                if (!searchableFields.some(field => field.toLowerCase().includes(searchTerm))) {
                    return false;
                }
            }

            return true;
        }

        getReceiptsFromStorage() {
            try {
                const stored = localStorage.getItem('mfix_receipts');
                if (!stored) return [];
                
                try {
                    JSON.parse(stored);
                    return JSON.parse(stored);
                } catch (e) {
                    if (typeof decryptData === 'function') {
                        return decryptData(stored);
                    }
                    return [];
                }
            } catch (e) {
                console.error("Error loading receipts:", e);
                return [];
            }
        }
    }

    // ğŸ“Š ENHANCED MESSAGE TEMPLATES SYSTEM
    class MessageTemplates {
        static getTemplate(type, platform, variables = {}) {
            let template = MfixConfig.MESSAGE_TEMPLATES[type]?.[platform];
            
            if (!template) {
                console.warn(`Template not found: ${type}.${platform}`);
                return '';
            }

            Object.entries(variables).forEach(([key, value]) => {
                template = template.replace(new RegExp(`{${key}}`, 'g'), value);
            });

            return template;
        }

        static sendTemplateMessage(type, platform, receipt, customVariables = {}) {
            const variables = {
                customerName: receipt.customerName,
                deviceModel: receipt.deviceModel,
                phone: receipt.phone,
                docNumber: receipt.docNumber,
                totalAmount: receipt.totalAmount?.toFixed(2),
                ...customVariables
            };

            const message = this.getTemplate(type, platform, variables);

            switch (platform) {
                case 'whatsapp':
                    this.sendWhatsApp(receipt.phone, message);
                    break;
                case 'email':
                    this.sendEmail(receipt.email, `Mfix - ${type === 'completion' ? '×ª×™×§×•×Ÿ ×”×•×©×œ×' : '×ª×–×›×•×¨×ª'}`, message);
                    break;
                case 'sms':
                    this.sendSMS(receipt.phone, message);
                    break;
            }
        }

        static sendWhatsApp(phone, message) {
            const cleanPhone = this.formatIsraeliPhone(phone);
            if (!cleanPhone) {
                console.error('Invalid phone number for WhatsApp');
                return;
            }

            const encodedMessage = encodeURIComponent(message);
            window.open(`https://wa.me/${cleanPhone}?text=${encodedMessage}`, '_blank');
        }

        static sendEmail(email, subject, body) {
            if (!email) {
                console.error('No email address provided');
                return;
            }

            window.location.href = `mailto:${email}?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;
        }

        static sendSMS(phone, body) {
            const cleanPhone = this.formatIsraeliPhone(phone);
            if (!cleanPhone) {
                console.error('Invalid phone number for SMS');
                return;
            }

            window.location.href = `sms:${cleanPhone}?body=${encodeURIComponent(body)}`;
        }

        static formatIsraeliPhone(phone) {
            let clean = phone.replace(/\D/g, '');
            if (clean.startsWith('00')) clean = clean.substring(2);
            if (clean.startsWith('972')) return clean;
            if (clean.startsWith('0')) return '972' + clean.substring(1);
            if (clean.length === 9 && clean.startsWith('5')) return '972' + clean;
            return clean;
        }
    }

    // ğŸ¯ INITIALIZATION AND INTEGRATION
    class MfixEnhancements {
        static init() {
            console.log('ğŸš€ Initializing Mfix Enhancements...');
            
            ErrorHandler.setupGlobalErrorHandling();
            UXEnhancements.init();
            
            this.advancedSearch = new AdvancedSearch();
            
            this.enhanceExistingFunctions();
            
            this.setupPerformanceMonitoring();
            
            console.log('âœ… Mfix Enhancements initialized successfully');
        }

        static enhanceExistingFunctions() {
            const originalSearchReceipts = window.searchReceipts;
            if (originalSearchReceipts) {
                window.searchReceipts = this.debounceSearch(originalSearchReceipts);
            }

            const originalGenerateAndSaveForm = window.generateAndSaveForm;
            if (originalGenerateAndSaveForm) {
                window.generateAndSaveForm = this.addValidationToForm(originalGenerateAndSaveForm);
            }
        }

        static debounceSearch(originalFunction) {
            const performanceManager = new PerformanceManager();
            
            return function() {
                performanceManager.debounce('search', originalFunction, MfixConfig.SEARCH_DEBOUNCE);
            };
        }

        static addValidationToForm(originalFunction) {
            return function() {
                const formData = {
                    customerName: document.getElementById('customerName')?.value?.trim(),
                    phone: document.getElementById('phone')?.value?.trim(),
                    email: document.getElementById('email')?.value?.trim(),
                    deviceType: document.getElementById('deviceType')?.value,
                    deviceModel: document.getElementById('deviceModel')?.value?.trim(),
                    totalAmount: parseFloat(document.getElementById('totalAmount')?.value) || 0,
                    issueDescription: document.getElementById('issueDescription')?.value?.trim()
                };

                const errors = ValidationManager.validateFormData(formData);
                
                if (errors.length > 0) {
                    errors.forEach(error => {
                        if (typeof showNotification === 'function') {
                            showNotification(error, 'error');
                        } else {
                            alert(error);
                        }
                    });
                    return;
                }

                return originalFunction();
            };
        }

        static setupPerformanceMonitoring() {
            if ('PerformanceObserver' in window) {
                const observer = new PerformanceObserver((list) => {
                    list.getEntries().forEach((entry) => {
                        if (entry.duration > 100) {
                            console.warn('Long task detected:', entry);
                        }
                    });
                });

                observer.observe({ entryTypes: ['longtask'] });
            }

            setInterval(() => {
                if (performance.memory) {
                    const used = performance.memory.usedJSHeapSize;
                    const limit = performance.memory.jsHeapSizeLimit;
                    
                    if (used / limit > 0.8) {
                        console.warn('High memory usage detected:', (used / 1024 / 1024).toFixed(2), 'MB');
                    }
                }
            }, 30000);
        }
    }

    // ×™×¦×™×¨×ª ××•×¤×¢ ×’×œ×•×‘×œ×™ ×œ×—×™×¤×•×© ××ª×§×“×
    window.advancedSearchManager = new AdvancedSearch();

    // ××ª×—×•×œ ×›×©×”×“×£ × ×˜×¢×Ÿ
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', () => MfixEnhancements.init());
    } else {
        MfixEnhancements.init();
    }

    // Export for global access
    window.MfixEnhancements = MfixEnhancements;
    window.MessageTemplates = MessageTemplates;
  </script>
</body>
</html>